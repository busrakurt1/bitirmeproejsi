package com.cvbuilder.external;

import com.cvbuilder.dto.OptimizedCvItem;
import com.cvbuilder.dto.UserCertificateDTO;
import com.cvbuilder.dto.UserEducationDTO;
import com.cvbuilder.dto.UserLanguageDTO;
import com.cvbuilder.dto.UserProjectDTO;
import com.cvbuilder.entity.JobPosting;
import com.cvbuilder.entity.UserProfile;
import com.cvbuilder.entity.UserSkill;
import com.cvbuilder.service.TranslationService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import java.time.LocalDate;
import java.time.format.DateTimeFormatter;
import java.util.ArrayList;
import java.util.Collections;
import java.util.List;
import java.util.stream.Collectors;

@Component
public class AiClient {

    private static final DateTimeFormatter DATE_FORMATTER = DateTimeFormatter.ofPattern("MM/yyyy");
    
    private final TranslationService translationService;

    @Autowired
    public AiClient(TranslationService translationService) {
        this.translationService = translationService;
    }

    // =========================================================
    // 1) DEBUG / HAM TEXT CV
    // =========================================================
    public String generateCv(UserProfile profile, JobPosting jobPosting) {
        String userName = (profile != null && profile.getUser() != null)
                ? safe(profile.getUser().getFullName())
                : "Ad Soyad BelirtilmemiÅŸ";
        return "CV GENERATION DEBUG FOR: " + userName;
    }

    // =========================================================
    // 2) TAILORED SUMMARY
    // =========================================================
    public List<String> generateTailoredSummaries(UserProfile profile, String jobContext) {
        String userTitle = profile != null ? safe(profile.getTitle()) : "YazÄ±lÄ±m GeliÅŸtirici";
        String userSkills = "";
        if (profile != null && profile.getSkills() != null && !profile.getSkills().isEmpty()) {
            userSkills = profile.getSkills().stream()
                    .map(UserSkill::getSkillName)
                    .filter(s -> s != null && !s.isBlank())
                    .limit(5)
                    .collect(Collectors.joining(", "));
        }
        if (userSkills.isEmpty()) userSkills = "gÃ¼ncel yazÄ±lÄ±m teknolojileri";

        List<String> summaries = new ArrayList<>();
        summaries.add(String.format("%s alanÄ±nda gÃ¼Ã§lÃ¼ bir teknik altyapÄ±ya sahip, sonuÃ§ odaklÄ± bir yazÄ±lÄ±m geliÅŸtiricisiyim. Ã–zellikle %s konularÄ±ndaki deneyimimle, Ã¶lÃ§eklenebilir ve sÃ¼rdÃ¼rÃ¼lebilir uygulamalar geliÅŸtirmeye odaklanÄ±yorum.", userTitle, userSkills));
        summaries.add(String.format("%s rolÃ¼nde, %s teknolojilerini kullanarak performans, gÃ¼venilirlik ve kullanÄ±cÄ± deneyimini merkeze alan Ã§Ã¶zÃ¼mler Ã¼retiyorum.", userTitle, userSkills));
        summaries.add(String.format("%s olarak, sÃ¼rekli Ã¶ÄŸrenme ve kendini geliÅŸtirme kÃ¼ltÃ¼rÃ¼nÃ¼ benimsemiÅŸ bir geliÅŸtiriciyim. %s baÅŸta olmak Ã¼zere yeni teknolojileri yakÄ±ndan takip ediyorum.", userTitle, userSkills));
        return summaries;
    }

    public String generateTailoredSummary(UserProfile profile, String jobContext) {
        List<String> list = generateTailoredSummaries(profile, jobContext);
        return list.isEmpty() ? "" : list.get(0);
    }

    // =========================================================
    // 3) OPTIMIZE EXPERIENCES (HÄ°BRÄ°T YAPI)
    // =========================================================
    public List<OptimizedCvItem> optimizeExperiences(UserProfile profile, JobPosting job) {
        if (profile == null || profile.getExperiences() == null || profile.getExperiences().isEmpty()) {
            return Collections.emptyList();
        }

        String requiredSkills = (job != null && job.getRequiredSkills() != null) ? job.getRequiredSkills() : "";

        return profile.getExperiences().stream()
                .map(exp -> {
                    String dateRange = formatDateRange(exp.getStartDate(), exp.getEndDate());
                    String originalDesc = safe(exp.getDescription());

                    List<String> bulletPoints = new ArrayList<>();

                    // EÄŸer description "Java, Spring" gibi keyword halindeyse HÄ°BRÄ°T metodu Ã§aÄŸÄ±r
                    if (originalDesc.contains(",") || (originalDesc.length() > 0 && originalDesc.length() < 50)) {
                        List<String> generated = generateSentencesFromKeywords(originalDesc);
                        bulletPoints.addAll(generated);
                    } else if (!originalDesc.isEmpty()) {
                        bulletPoints.add(originalDesc);
                    }

                    if (bulletPoints.isEmpty()) {
                        bulletPoints.add("Backend geliÅŸtirme sÃ¼reÃ§lerinde aktif rol aldÄ±m.");
                    }
                    if (!requiredSkills.isEmpty()) {
                        bulletPoints.add("Ä°lan kapsamÄ±nda belirtilen " + requiredSkills + " teknolojilerini projelere entegre ederek verimliliÄŸi artÄ±rdÄ±m.");
                    }
                    bulletPoints.add("Agile/Scrum metodolojileriyle Ã§alÄ±ÅŸan ekip iÃ§inde sprint hedeflerinin zamanÄ±nda tamamlanmasÄ±na destek oldum.");

                    return new OptimizedCvItem(safe(exp.getPosition()), safe(exp.getCompany()), dateRange, bulletPoints);
                })
                .collect(Collectors.toList());
    }

    // =========================================================
    // 4) ğŸ”¥ DÃœZELTÄ°LEN KISIM: OPTIMIZE PROJECTS (HÄ°BRÄ°T YAPI EKLENDÄ°)
    // =========================================================
    public List<OptimizedCvItem> optimizeProjects(UserProfile profile, JobPosting job) {
        if (profile == null || profile.getProjects() == null || profile.getProjects().isEmpty()) {
            return Collections.emptyList();
        }

        return profile.getProjects().stream()
                .map(project -> {
                    String dateRange = formatDateRange(project.getStartDate(), project.getIsOngoing() ? null : project.getEndDate());
                    
                    // 1. KullanÄ±cÄ±nÄ±n girdiÄŸi aÃ§Ä±klama
                    String originalDesc = safe(project.getDescription());
                    List<String> bulletPoints = new ArrayList<>();

                    // 2. MantÄ±k: VirgÃ¼l varsa veya kÄ±saysa AI/Keyword motoruna sok
                    if (originalDesc.contains(",") || (originalDesc.length() > 0 && originalDesc.length() < 50)) {
                        // ğŸ”¥ HÄ°BRÄ°T MOTORU Ã‡AÄIRIYORUZ
                        List<String> generated = generateSentencesFromKeywords(originalDesc);
                        bulletPoints.addAll(generated);
                    } else if (!originalDesc.isEmpty()) {
                        // KullanÄ±cÄ± zaten uzun cÃ¼mle yazmÄ±ÅŸsa olduÄŸu gibi koru
                        bulletPoints.add(originalDesc);
                    }

                    // 3. Fallback: Standart metinler
                    if (bulletPoints.isEmpty()) {
                        bulletPoints.add("Proje geliÅŸtirme sÃ¼reÃ§lerinde aktif rol aldÄ±m ve gereksinimlere uygun fonksiyonel modÃ¼ller geliÅŸtirdim.");
                        bulletPoints.add("Teknik Ã§Ã¶zÃ¼mler Ã¼reterek projenin hedeflerine ve zaman planÄ±na uygun ÅŸekilde ilerlemesini saÄŸladÄ±m.");
                        bulletPoints.add("Ekip iÃ§i iÅŸ birliÄŸi ve dÃ¼zenli geribildirimlerle projenin baÅŸarÄ±yla tamamlanmasÄ±na katkÄ±da bulundum.");
                    }

                    return new OptimizedCvItem(
                            safe(project.getProjectName()), 
                            "Personal Project", 
                            dateRange, 
                            bulletPoints
                    );
                })
                .collect(Collectors.toList());
    }

    // =========================================================
    // 5) ğŸ”¥ DÃœZELTÄ°LEN KISIM: USER PROJECT DTO (Description Eklendi)
    // =========================================================
    public List<UserProjectDTO> optimizeUserProjects(UserProfile profile, JobPosting job) {
         if (profile == null || profile.getProjects() == null) return Collections.emptyList();
         
         return profile.getProjects().stream()
                 .map(p -> UserProjectDTO.builder()
                         .id(p.getId())
                         .projectName(safe(p.getProjectName()))
                         .startDate(p.getStartDate())
                         .endDate(p.getEndDate())
                         .isOngoing(p.getIsOngoing())
                         .description(safe(p.getDescription())) // ğŸ”¥ BURASI EKSÄ°KTÄ°, EKLENDÄ°
                         .build())
                 .collect(Collectors.toList());
    }

    // =========================================================
    // ğŸ”¥ HÄ°BRÄ°T MOTOR: Ã–NCE LOCAL KONTROL, YOKSA API
    // =========================================================
    private List<String> generateSentencesFromKeywords(String rawKeywords) {
        if (rawKeywords == null || rawKeywords.isBlank()) return new ArrayList<>();

        List<String> finalSentences = new ArrayList<>();
        List<String> unknownKeywords = new ArrayList<>(); // API'ye sorulacaklar

        String[] keys = rawKeywords.split("[,;\\n]");
        System.out.println("ğŸ” Kelime Analizi: " + rawKeywords);

        for (String key : keys) {
            String cleanKey = key.trim();
            if (cleanKey.isEmpty()) continue;

            // 1. ADIM: Ã–nce Kod Ä°Ã§indeki Listeye Bak (0ms Gecikme)
            String hardcoded = checkHardcodedList(cleanKey);
            if (hardcoded != null) {
                System.out.println("âœ… LOCAL BULUNDU: " + cleanKey);
                finalSentences.add(hardcoded);
            } else {
                System.out.println("â“ BÄ°LÄ°NMÄ°YOR (API'ye Sorulacak): " + cleanKey);
                unknownKeywords.add(cleanKey);
            }
        }

        // 2. ADIM: Bilinmeyenleri TOPLU (Batch) Olarak AI'ya Sor
        if (!unknownKeywords.isEmpty()) {
            try {
                String keywordsString = String.join(", ", unknownKeywords);
                String prompt = String.format(
                    "AÅŸaÄŸÄ±daki teknoloji listesi iÃ§in TÃ¼rkÃ§e CV (Ã–zgeÃ§miÅŸ) deneyim maddeleri yaz.\n" +
                    "Teknolojiler: [%s]\n" +
                    "Kurallar:\n" +
                    "1. Her teknoloji iÃ§in SADECE 1 cÃ¼mle yaz.\n" +
                    "2. CÃ¼mleler 'geliÅŸtirildi, tasarlandÄ±, kullanÄ±ldÄ±' gibi profesyonel ve edilgen yapÄ±da olsun.\n" +
                    "3. Sadece maddeleri ver, baÅŸka hiÃ§bir aÃ§Ä±klama yapma.\n" +
                    "4. Teknolojinin adÄ±nÄ± **kalÄ±n** yap.", 
                    keywordsString
                );

                String aiResponse = translationService.generateContent(prompt);
                
                if (aiResponse != null && !aiResponse.isBlank()) {
                    String[] lines = aiResponse.split("\n");
                    for (String line : lines) {
                        String cleanLine = line.replaceAll("^[-*â€¢]\\s*", "").trim();
                        if (!cleanLine.isEmpty()) {
                            finalSentences.add(cleanLine);
                            System.out.println("ğŸ¤– API CEVABI: " + cleanLine);
                        }
                    }
                }
            } catch (Exception e) {
                System.err.println("âš ï¸ AI HatasÄ± (Fallback Devrede): " + e.getMessage());
                for (String k : unknownKeywords) {
                    finalSentences.add("**" + k + "** teknolojisi proje gereksinimlerine uygun ÅŸekilde entegre edilerek aktif kullanÄ±ldÄ±.");
                }
            }
        }
        return finalSentences;
    }

    private String checkHardcodedList(String key) {
        String lowerKey = key.toLowerCase();
        if (lowerKey.contains("java") || lowerKey.contains("jakarta")) return "**" + key + "** ekosistemi ile Ã¶lÃ§eklenebilir backend mimarileri kurgulandÄ±.";
        if (lowerKey.contains("spring")) return "**" + key + "** framework'Ã¼ kullanÄ±larak modÃ¼ler mikroservisler geliÅŸtirildi.";
        if (lowerKey.contains("react") || lowerKey.contains("vue")) return "**" + key + "** ile modern ve responsive kullanÄ±cÄ± arayÃ¼zleri tasarlandÄ±.";
        if (lowerKey.contains("docker")) return "**" + key + "** ile konteynerizasyon sÃ¼reÃ§leri yÃ¶netildi.";
        if (lowerKey.contains("aws") || lowerKey.contains("azure")) return "**" + key + "** bulut servisleri kullanÄ±larak yÃ¼ksek eriÅŸilebilirliÄŸe sahip yapÄ±lar kuruldu.";
        if (lowerKey.contains("sql") || lowerKey.contains("postgres")) return "**" + key + "** Ã¼zerinde veri modelleme ve performans optimizasyonu yapÄ±ldÄ±.";
        return null;
    }

    public List<UserLanguageDTO> optimizeLanguages(UserProfile profile, JobPosting job) {
        if (profile == null || profile.getLanguages() == null) return Collections.emptyList();
        return profile.getLanguages().stream().map(l -> UserLanguageDTO.builder().id(l.getId()).language(safe(l.getLanguage())).level(safe(l.getLevel())).build()).collect(Collectors.toList());
    }

    public List<UserCertificateDTO> optimizeCertificates(UserProfile profile, JobPosting job) {
        if (profile == null || profile.getCertificates() == null) return Collections.emptyList();
        return profile.getCertificates().stream().map(c -> UserCertificateDTO.builder().id(c.getId()).name(safe(c.getName())).issuer(safe(c.getIssuer())).date(safe(c.getDate())).url(safe(c.getUrl())).build()).collect(Collectors.toList());
    }

    public List<UserEducationDTO> optimizeEducation(UserProfile profile, JobPosting job) {
        if (profile == null || profile.getEducationSchool() == null) return Collections.emptyList();
        UserEducationDTO dto = UserEducationDTO.builder()
                .university(safe(profile.getEducationSchool()))
                .startYear(safe(profile.getEducationStartYear()))
                .graduationYear(profile.getEducationEndYear() != null ? profile.getEducationEndYear() : "Present")
                .build();
        return List.of(dto);
    }

    private String safe(String text) { return text != null ? text : ""; }
    private String formatDateRange(String start, String end) {
        if (start == null) return "";
        return start + (end != null ? " - " + end : " - Devam Ediyor");
    }
    private String formatLocalDate(LocalDate date) { return date != null ? date.format(DATE_FORMATTER) : ""; }
}