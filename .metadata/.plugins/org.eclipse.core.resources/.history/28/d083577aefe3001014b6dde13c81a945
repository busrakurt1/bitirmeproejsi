package com.cvbuilder.service;

import com.cvbuilder.dto.JobAnalysisResponse;
import com.cvbuilder.dto.MarketAnalysisResponse;
import com.cvbuilder.entity.JobPosting;
import com.cvbuilder.entity.User;
import com.cvbuilder.entity.UserProfile;
import com.cvbuilder.external.AiClient;
import com.cvbuilder.external.JobScraperClient;
import com.cvbuilder.repository.JobPostingRepository;
import com.cvbuilder.repository.UserProfileRepository;
import com.cvbuilder.repository.UserRepository;
import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.context.annotation.Primary;
import org.springframework.data.domain.PageRequest;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.*;
import java.util.stream.Collectors;

@Slf4j
@Service
@Primary
@RequiredArgsConstructor
public class JobAnalysisServiceImpl implements JobAnalysisService {

    private final UserRepository userRepository;
    private final UserProfileRepository userProfileRepository;
    private final JobPostingRepository jobPostingRepository;
    private final JobScraperClient scraper;
    private final AiClient aiClient;
    private final ObjectMapper objectMapper;

    // =================================================================================
    // ğŸ“Š PAZAR ANALÄ°ZÄ° (FÄ°LTRE ODAKLI VE DERÄ°N ANALÄ°Z)
    // =================================================================================
    @Override
    @Transactional(readOnly = true)
    public MarketAnalysisResponse performMarketAnalysis(String area, Long userId) {
        log.info("Pazar analizi yÃ¼rÃ¼tÃ¼lÃ¼yor. KullanÄ±cÄ±: {}, Alan: {}", userId, area);

        UserProfile userProfile = userProfileRepository.findByUserId(userId)
                .orElseThrow(() -> new IllegalArgumentException("KullanÄ±cÄ± profili bulunamadÄ±"));

        // Analiz edilecek alan boÅŸsa kullanÄ±cÄ±nÄ±n unvanÄ±nÄ± kullan
        String analysisArea = (area != null && !area.trim().isEmpty()) ? area.trim() : userProfile.getTitle();

        // 1) SADECE Ä°LGÄ°LÄ° Ä°LANLARI GETÄ°R (AlakasÄ±z findAll() kaldÄ±rÄ±ldÄ±)
        List<JobPosting> filteredJobs = jobPostingRepository.searchMarketData(analysisArea, PageRequest.of(0, 100));

        if (filteredJobs.isEmpty()) {
            throw new RuntimeException("VeritabanÄ±nda '" + analysisArea + "' alanÄ± ile ilgili yeterli ilan bulunamadÄ±. LÃ¼tfen Ã¶nce bu alanda birkaÃ§ ilanÄ± analiz edip kaydedin.");
        }

        // 2) DERÄ°N YETENEK FREKANSI HESAPLA
        Map<String, Integer> skillFrequencies = new HashMap<>();
        for (JobPosting job : filteredJobs) {
            Set<String> skillsInJob = deepExtractSkills(job);
            for (String s : skillsInJob) {
                skillFrequencies.put(s, skillFrequencies.getOrDefault(s, 0) + 1);
            }
        }

        // 3) Ã–NCELÄ°KLENDÄ°RME (KullanÄ±cÄ± yetenekleriyle kÄ±yaslama)
        List<String> topMarketSkills = skillFrequencies.entrySet().stream()
                .sorted(Map.Entry.<String, Integer>comparingByValue().reversed())
                .limit(25)
                .map(Map.Entry::getKey)
                .collect(Collectors.toList());

        Set<String> userSkills = getUserSkillSet(userProfile);

        List<String> matchedSkills = topMarketSkills.stream()
                .filter(s -> checkIfUserHasSkill(s, userSkills))
                .map(this::capitalizeFirstLetter)
                .collect(Collectors.toList());

        List<String> missingSkills = topMarketSkills.stream()
                .filter(s -> !checkIfUserHasSkill(s, userSkills))
                .limit(10)
                .map(this::capitalizeFirstLetter)
                .collect(Collectors.toList());

        // 4) AI STRATEJÄ° ÃœRETÄ°MÄ°
        String strategyPrompt = createMarketStrategyPrompt(analysisArea, userProfile, matchedSkills, missingSkills);
        String aiRecommendation = aiClient.getQuickMarketAnalysis(strategyPrompt, filteredJobs, userProfile);

        return MarketAnalysisResponse.builder()
                .area(analysisArea)
                .userDepartment(userProfile.getDepartment())
                .userTitle(userProfile.getTitle())
                .topSkillsInMarket(skillFrequencies)
                .userMissingSkills(missingSkills)
                .aiRecommendation(aiRecommendation)
                .isAutoAnalyzed(area == null || area.isBlank())
                .build();
    }

    // =================================================================================
    // ğŸ› ï¸ DERÄ°N YETENEK AYIKLAMA (cleanedText + requiredSkills)
    // =================================================================================
    private Set<String> deepExtractSkills(JobPosting job) {
        Set<String> skills = new HashSet<>();
        
        // 1. KayÄ±tlÄ± yetenek listesini temizle (Lokal veriden temizlik)
        if (job.getRequiredSkills() != null) {
            Arrays.stream(job.getRequiredSkills().split("[,;\\n]"))
                    .map(s -> s.trim().toLowerCase())
                    .filter(s -> s.length() > 2 && !s.contains("belirtilmemiÅŸ"))
                    .forEach(skills::add);
        }

        // 2. TÃ¼m metni tarayarak teknik kelimeleri yakala (Logdaki veriler iÃ§in kritik)
        if (job.getCleanedText() != null) {
            String text = job.getCleanedText().toLowerCase();
            // GeniÅŸletilebilir teknoloji sÃ¶zlÃ¼ÄŸÃ¼
            String[] dictionary = {"java", "spring", "sql", "docker", "kubernetes", "react", "python", "miro", "aws", "angular", "node", "typescript", "c#", ".net"};
            for (String tech : dictionary) {
                if (text.contains(tech)) skills.add(tech);
            }
        }
        return skills;
    }

    // =================================================================================
    // ğŸ” TEKÄ°L Ä°LAN ANALÄ°ZÄ°
    // =================================================================================
    @Override
    @Transactional
    public JobAnalysisResponse analyzeJobPosting(Long userId, String url) {
        User user = userRepository.findById(userId)
                .orElseThrow(() -> new IllegalArgumentException("KullanÄ±cÄ± bulunamadÄ±"));

        Map<String, String> scrapedData = scraper.fetchJobData(url);
        String jobContent = scrapedData.getOrDefault("jobContent", scrapedData.getOrDefault("fullText", ""));

        if (jobContent == null || jobContent.isBlank()) {
            throw new RuntimeException("Ä°lan iÃ§eriÄŸi alÄ±namadÄ±.");
        }

        String jsonResult = aiClient.analyzeJobPostingUniversal(jobContent);
        JobAiResult aiData = parseAiResult(jsonResult);

        List<String> userSkills = user.getProfile().getSkills().stream()
                .map(s -> s.getSkillName().toLowerCase().trim()).collect(Collectors.toList());

        List<String> matched = aiData.technicalSkills.stream()
                .filter(req -> userSkills.stream().anyMatch(u -> req.toLowerCase().contains(u)))
                .collect(Collectors.toList());

        String report = generateUniversalReport(aiData, matched);
        JobPosting jp = saveJobPosting(user, url, aiData, jobContent, report);

        return JobAnalysisResponse.builder()
                .jobId(jp.getId())
                .matchedSkills(matched)
                .position(aiData.position)
                .company(aiData.company)
                .formattedAnalysis(report)
                .matchScore(aiData.technicalSkills.isEmpty() ? 0 : (int)Math.round((matched.size() * 100.0) / aiData.technicalSkills.size()))
                .build();
    }

    // =================================================================================
    // è¾…åŠ© YardÄ±mcÄ± Metotlar
    // =================================================================================

    private String createMarketStrategyPrompt(String area, UserProfile profile, List<String> matched, List<String> missing) {
        return String.format("""
                Sen kÄ±demli Ä°K Stratejistisin. %s pazarÄ± iÃ§in adayÄ± analiz et.
                GÃ¼Ã§lÃ¼ Yanlar (EÅŸleÅŸen): %s
                GeliÅŸim AlanlarÄ± (Eksik): %s
                Bu adayÄ±n rekabet gÃ¼cÃ¼nÃ¼ puanla ve 3 maddelik stratejik yol haritasÄ± Ã§iz.
                """, area, String.join(", ", matched), String.join(", ", missing));
    }

    private boolean checkIfUserHasSkill(String marketSkill, Set<String> userSkills) {
        return userSkills.stream().anyMatch(us -> marketSkill.toLowerCase().contains(us.toLowerCase()));
    }

    private Set<String> getUserSkillSet(UserProfile userProfile) {
        if (userProfile.getSkills() == null) return Collections.emptySet();
        return userProfile.getSkills().stream()
                .map(us -> us.getSkillName().toLowerCase().trim())
                .collect(Collectors.toSet());
    }

    private String capitalizeFirstLetter(String s) {
        if (s == null || s.isEmpty()) return s;
        return s.substring(0, 1).toUpperCase() + s.substring(1);
    }

    private JobPosting saveJobPosting(User user, String url, JobAiResult aiData, String rawText, String report) {
        JobPosting jp = JobPosting.builder()
                .user(user).url(url).position(aiData.position).title(aiData.company)
                .requiredSkills(String.join(", ", aiData.technicalSkills))
                .cleanedText(rawText.substring(0, Math.min(rawText.length(), 3900)))
                .analysisReport(report).createdAt(new Date()).build();
        return jobPostingRepository.save(jp);
    }

    private JobAiResult parseAiResult(String json) {
        JobAiResult result = new JobAiResult();
        try {
            JsonNode root = objectMapper.readTree(json);
            result.position = root.path("position").asText("BelirtilmemiÅŸ");
            result.company = root.path("company").asText("BelirtilmemiÅŸ");
            root.path("technicalSkills").forEach(n -> result.technicalSkills.add(n.asText()));
        } catch (Exception e) { log.error("Parse hatasÄ±"); }
        return result;
    }

    private String generateUniversalReport(JobAiResult data, List<String> matched) {
        StringBuilder sb = new StringBuilder("### ANALÄ°Z\n\n");
        data.technicalSkills.forEach(s -> sb.append(matched.contains(s) ? "âœ… " : "âŒ ").append(s).append("\n"));
        return sb.toString();
    }

    @Override public List<JobPosting> getJobsByUserId(Long userId) { return jobPostingRepository.findByUserIdOrderByCreatedAtDesc(userId); }
    @Override public JobPosting getJobById(Long jobId) { return jobPostingRepository.findById(jobId).orElse(null); }
    @Override public JobAnalysisResponse analyzeJobPosting(Object object, String url) { return null; }

    private static class JobAiResult {
        public String position;
        public String company;
        public List<String> technicalSkills = new ArrayList<>();
    }
}