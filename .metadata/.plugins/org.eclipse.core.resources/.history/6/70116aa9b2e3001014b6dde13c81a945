package com.cvbuilder.client;

import com.cvbuilder.external.LlmClient;
import com.cvbuilder.config.GroqProperties;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.http.*;
import org.springframework.stereotype.Service;
import org.springframework.web.client.RestTemplate;

import java.util.*;
import java.util.concurrent.ThreadLocalRandom;

@Slf4j
@Service
@Qualifier("groqClient")
@RequiredArgsConstructor
public class GroqLlamaClient implements LlmClient {

    private final GroqProperties groqProperties;
    private final RestTemplate restTemplate = new RestTemplate();

    @Override
    @SuppressWarnings("unchecked")
    public String generateContent(String prompt) {
        String url = groqProperties.getApi().getUrl();
        String model = groqProperties.getModel();

        List<String> keys = groqProperties.keyList();
        if (keys.isEmpty()) {
            throw new IllegalStateException("GROQ api keys boş. 'groq.api.keys' ayarla (ENV önerilir).");
        }
        String key = keys.get(ThreadLocalRandom.current().nextInt(keys.size()));

        Map<String, Object> body = new HashMap<>();
        body.put("model", model);

        // Groq OpenAI uyumlu: messages gerekir
        List<Map<String, String>> messages = List.of(
                Map.of("role", "system", "content", "You are a helpful assistant."),
                Map.of("role", "user", "content", prompt)
        );
        body.put("messages", messages);

        // İstersen ayarlayabilirsin
        body.put("temperature", 0.4);

        HttpHeaders headers = new HttpHeaders();
        headers.setContentType(MediaType.APPLICATION_JSON);
        headers.setBearerAuth(key);

        HttpEntity<Map<String, Object>> entity = new HttpEntity<>(body, headers);

        try {
            ResponseEntity<Map> resp = restTemplate.exchange(url, HttpMethod.POST, entity, Map.class);
            Map<String, Object> map = resp.getBody();
            if (map == null) return "";

            // choices[0].message.content
            List<Map<String, Object>> choices = (List<Map<String, Object>>) map.get("choices");
            if (choices == null || choices.isEmpty()) return "";

            Map<String, Object> first = choices.get(0);
            Map<String, Object> message = (Map<String, Object>) first.get("message");
            if (message == null) return "";

            Object content = message.get("content");
            return content == null ? "" : content.toString();

        } catch (Exception e) {
            log.error("GroqLlamaClient error: {}", e.getMessage());
            throw e;
        }
    }
}
