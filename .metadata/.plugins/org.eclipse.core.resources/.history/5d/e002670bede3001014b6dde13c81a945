package com.cvbuilder.service;

import com.cvbuilder.dto.JobAnalysisResponse;
import com.cvbuilder.dto.MarketAnalysisResponse;
import com.cvbuilder.entity.JobPosting;
import com.cvbuilder.entity.User;
import com.cvbuilder.entity.UserProfile;
import com.cvbuilder.entity.UserSkill;
import com.cvbuilder.external.AiClient;
import com.cvbuilder.external.JobScraperClient;
import com.cvbuilder.repository.JobPostingRepository;
import com.cvbuilder.repository.UserProfileRepository;
import com.cvbuilder.repository.UserRepository;
import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Sort;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.*;
import java.util.stream.Collectors;
import java.util.stream.StreamSupport;

@Slf4j
@Service
@RequiredArgsConstructor
public class AiCvService implements JobAnalysisService {

    private final UserRepository userRepository;
    private final UserProfileRepository userProfileRepository;
    private final JobPostingRepository jobPostingRepository;
    private final JobScraperClient scraper;
    private final AiClient aiClient;
    private final ObjectMapper objectMapper;

    // =================================================================================
    // ğŸ“Š PAZAR ANALÄ°ZÄ° (GELÄ°ÅTÄ°RÄ°LMÄ°Å VERSÄ°YON)
    // =================================================================================
    @Override
    @Transactional(readOnly = true)
    public MarketAnalysisResponse performMarketAnalysis(String area, Long userId) {
        log.info("Pazar analizi yÃ¼rÃ¼tÃ¼lÃ¼yor. KullanÄ±cÄ± ID: {}, Talep edilen alan: {}", userId, area);

        UserProfile userProfile = userProfileRepository.findByUserId(userId)
                .orElseThrow(() -> new IllegalArgumentException("KullanÄ±cÄ± profili bulunamadÄ±"));

        String analysisArea = (area != null && !area.trim().isEmpty()) ? area.trim() : userProfile.getDepartment();
        if (analysisArea == null || analysisArea.isBlank()) {
            throw new IllegalArgumentException("Analiz iÃ§in bir alan (area) girilmeli veya profil departmanÄ± dolu olmalÄ±dÄ±r.");
        }

        // 1) Pazardaki Ä°lgili Ä°lanlarÄ± Getir
        List<JobPosting> filteredJobs = getRelevantJobPostings(analysisArea);
        if (filteredJobs.isEmpty()) {
            log.warn("SeÃ§ilen alanda ilan bulunamadÄ±, genel havuz kullanÄ±lÄ±yor.");
            filteredJobs = jobPostingRepository.findAll(PageRequest.of(0, 50, Sort.by(Sort.Direction.DESC, "createdAt"))).getContent();
        }

        // 2) PazarÄ±n Skill FrekansÄ±nÄ± Hesapla
        Map<String, Integer> skillFrequencies = new HashMap<>();
        for (JobPosting job : filteredJobs) {
            Set<String> skillsInJob = extractSkillsFromJobPosting(job);
            for (String s : skillsInJob) {
                skillFrequencies.put(s, skillFrequencies.getOrDefault(s, 0) + 1);
            }
        }

        // 3) MantÄ±ksal Ã–nceliklendirme (AiCvService Benzeri MantÄ±k)
        // PazarÄ±n en Ã§ok istediÄŸi ilk 25 yeteneÄŸi sÄ±ralÄ± liste olarak alalÄ±m
        List<String> topMarketSkills = skillFrequencies.entrySet().stream()
                .sorted(Map.Entry.<String, Integer>comparingByValue().reversed())
                .limit(25)
                .map(Map.Entry::getKey)
                .collect(Collectors.toList());

        Set<String> userSkills = getUserSkillSet(userProfile);

        // Kategori A: KullanÄ±cÄ±da olan ve pazarda talep gÃ¶renler (GÃ¼Ã§lÃ¼ Yanlar)
        List<String> matchedSkills = topMarketSkills.stream()
                .filter(skill -> checkIfUserHasSkill(skill, userSkills))
                .map(this::capitalizeFirstLetter)
                .collect(Collectors.toList());

        // Kategori B: Pazarda talep gÃ¶ren ama kullanÄ±cÄ±da olmayanlar (GeliÅŸim AlanlarÄ±)
        List<String> missingSkills = topMarketSkills.stream()
                .filter(skill -> !checkIfUserHasSkill(skill, userSkills))
                .limit(8) // KullanÄ±cÄ±yÄ± boÄŸmamak iÃ§in en kritik 8 tanesi
                .map(this::capitalizeFirstLetter)
                .collect(Collectors.toList());

        // 4) AI Strateji Ãœretimi (Prompt Engineering)
        String marketPrompt = createMarketAnalysisPrompt(analysisArea, userProfile, matchedSkills, missingSkills);
        String aiRecommendation = aiClient.getQuickMarketAnalysis(marketPrompt, filteredJobs, userProfile);

        return MarketAnalysisResponse.builder()
                .area(analysisArea)
                .userDepartment(userProfile.getDepartment())
                .userTitle(userProfile.getTitle())
                .topSkillsInMarket(skillFrequencies)
                .userMissingSkills(missingSkills)
                .aiRecommendation(aiRecommendation)
                .isAutoAnalyzed(area == null || area.isBlank())
                .build();
    }

    private String createMarketAnalysisPrompt(String area, UserProfile profile, List<String> matched, List<String> missing) {
        return String.format("""
                Sen uzman bir Ä°K Stratejisti ve Kariyer DanÄ±ÅŸmanÄ±sÄ±n. 
                AdayÄ±n mevcut profili ile %s alanÄ±ndaki pazar verilerini kÄ±yaslayarak bir yol haritasÄ± Ã§iz.
                
                ADAYIN ÃœNVANI: %s
                PAZARDA EÅLEÅEN GÃœÃ‡LÃœ YETENEKLERÄ°: %s
                PAZARDA TALEP EDÄ°LEN AMA ADAYDA EKSÄ°K OLANLAR: %s
                
                GÃ–REVÄ°N:
                1. AdayÄ±n bu alandaki "Pazar Uyumluluk Skorunu" (0-100 arasÄ±) belirle ve nedenini aÃ§Ä±kla.
                2. Eksik yetenekler arasÄ±ndan hangisinin iÅŸ bulma ÅŸansÄ±nÄ± en Ã§ok artÄ±racaÄŸÄ±nÄ± teknik gerekÃ§esiyle belirt.
                3. Kariyer geliÅŸimi iÃ§in 3-4 cÃ¼mlelik, profesyonel ve motive edici bir aksiyon planÄ± yaz.
                
                YanÄ±tÄ±n profesyonel, kÄ±sa ve net olsun.
                """, 
                area, profile.getTitle(), String.join(", ", matched), String.join(", ", missing));
    }

    // =================================================================================
    // ğŸ” TEKÄ°L Ä°LAN ANALÄ°ZÄ°
    // =================================================================================
    @Override
    @Transactional
    public JobAnalysisResponse analyzeJobPosting(Long userId, String url) {
        User user = userRepository.findById(userId)
                .orElseThrow(() -> new IllegalArgumentException("KullanÄ±cÄ± bulunamadÄ±"));

        Map<String, String> scrapedData = scraper.fetchJobData(url);
        String jobContent = scrapedData.getOrDefault("jobContent", scrapedData.getOrDefault("fullText", ""));

        if (jobContent == null || jobContent.isBlank()) {
            throw new RuntimeException("Ä°lan iÃ§eriÄŸi boÅŸ. Bot korumasÄ± olabilir.");
        }

        String jsonResult = aiClient.analyzeJobPostingUniversal(jobContent);
        JobAiResult aiData = parseAiResult(jsonResult);

        List<String> userSkills = getUserSkillsNormalized(user);
        List<String> matchedSkills = new ArrayList<>();
        List<String> missingSkills = new ArrayList<>();

        for (String reqSkill : aiData.technicalSkills) {
            if (isUserHasSkill(userSkills, reqSkill)) matchedSkills.add(reqSkill);
            else missingSkills.add(reqSkill);
        }

        String report = generateUniversalReport(aiData, matchedSkills);
        JobPosting jp = saveJobPosting(user, url, aiData, jobContent, report);

        int score = aiData.technicalSkills.isEmpty() ? 0 : (int) Math.round((matchedSkills.size() * 100.0) / aiData.technicalSkills.size());

        return JobAnalysisResponse.builder()
                .jobId(jp.getId())
                .matchedSkills(matchedSkills)
                .missingSkills(missingSkills)
                .position(emptyToUnspecified(aiData.position))
                .company(emptyToUnspecified(aiData.company))
                .matchScore(score)
                .formattedAnalysis(report)
                .summary(aiData.summary)
                .build();
    }

    // =================================================================================
    // ğŸ› ï¸ YARDIMCI METOTLAR (MANTIK VE DATA TEMÄ°ZLEME)
    // =================================================================================

    private Set<String> extractSkillsFromJobPosting(JobPosting job) {
        Set<String> skills = new HashSet<>();
        // 1. KayÄ±tlÄ± yetenekleri temizleyip ekle
        if (job.getRequiredSkills() != null) {
            Arrays.stream(job.getRequiredSkills().split("[,;\\n|]"))
                    .map(s -> s.trim().toLowerCase().replaceAll("[.(){}\\[\\]]", ""))
                    .filter(s -> s.length() > 1)
                    .forEach(skills::add);
        }
        // 2. Metin iÃ§inde anahtar kelime taramasÄ± (Fallback)
        if (job.getCleanedText() != null) {
            String text = job.getCleanedText().toLowerCase();
            String[] commonTech = {"java", "spring", "react", "docker", "kubernetes", "aws", "python", "sql", "node", "typescript", "c#", ".net"};
            for (String tech : commonTech) {
                if (text.contains(tech)) skills.add(tech);
            }
        }
        return skills;
    }

    private boolean checkIfUserHasSkill(String marketSkill, Set<String> userSkills) {
        String ms = marketSkill.toLowerCase().trim();
        return userSkills.stream().anyMatch(us -> ms.contains(us) || us.contains(ms));
    }

    private Set<String> getUserSkillSet(UserProfile userProfile) {
        if (userProfile.getSkills() == null) return Collections.emptySet();
        return userProfile.getSkills().stream()
                .map(us -> us.getSkillName() == null ? "" : us.getSkillName().toLowerCase().trim())
                .filter(s -> !s.isEmpty())
                .collect(Collectors.toSet());
    }

    private List<JobPosting> getRelevantJobPostings(String area) {
        // Pozisyona gÃ¶re en yeni 100 ilanÄ± getir
        List<JobPosting> matches = jobPostingRepository.findTop100ByPositionContainingIgnoreCaseOrderByCreatedAtDesc(area);
        if (matches.size() < 5) { // Ã‡ok az sonuÃ§ varsa kelime bazlÄ± geniÅŸlet
            String firstWord = area.split("\\s+")[0];
            matches.addAll(jobPostingRepository.findTop100ByPositionContainingIgnoreCaseOrderByCreatedAtDesc(firstWord));
        }
        return matches.stream().distinct().collect(Collectors.toList());
    }

    private String capitalizeFirstLetter(String text) {
        if (text == null || text.isEmpty()) return text;
        return text.substring(0, 1).toUpperCase() + text.substring(1).toLowerCase();
    }

    private String emptyToUnspecified(String s) {
        return (s == null || s.trim().isEmpty() || s.equalsIgnoreCase("null")) ? "BelirtilmemiÅŸ" : s.trim();
    }

    // ... parseAiResult, saveJobPosting ve diÄŸer yardÄ±mcÄ± metotlar (Ã¶nceki yapÄ±yla aynÄ±) ...
    // (Kodun devamÄ± Ã¶nceki sÃ¼rÃ¼mdeki JSON parse ve save mantÄ±ÄŸÄ±nÄ± iÃ§erir)

    @Override
    public List<JobPosting> getJobsByUserId(Long userId) {
        return jobPostingRepository.findByUserIdOrderByCreatedAtDesc(userId);
    }

    @Override
    public JobPosting getJobById(Long jobId) {
        return jobPostingRepository.findById(jobId).orElseThrow(() -> new RuntimeException("Ä°lan bulunamadÄ±"));
    }

    @Override
    public JobAnalysisResponse analyzeJobPosting(Object object, String url) { return null; }

    private List<String> getUserSkillsNormalized(User user) {
        if (user.getProfile() == null || user.getProfile().getSkills() == null) return new ArrayList<>();
        return user.getProfile().getSkills().stream()
                .map(s -> s.getSkillName().toLowerCase().trim())
                .distinct().collect(Collectors.toList());
    }

    private boolean isUserHasSkill(List<String> userSkills, String reqSkill) {
        String r = reqSkill.toLowerCase().trim();
        return userSkills.stream().anyMatch(u -> r.contains(u) || u.contains(r));
    }

    private JobPosting saveJobPosting(User user, String url, JobAiResult aiData, String rawText, String report) {
        JobPosting jp = JobPosting.builder()
                .user(user).url(url).position(aiData.position)
                .cleanedText(rawText.length() > 3900 ? rawText.substring(0, 3900) : rawText)
                .requiredSkills(String.join(", ", aiData.technicalSkills))
                .analysisReport(report).createdAt(new Date()).build();
        return jobPostingRepository.save(jp);
    }

    private String generateUniversalReport(JobAiResult data, List<String> matched) {
        StringBuilder sb = new StringBuilder("### ANALÄ°Z RAPORU\n\n");
        sb.append("**Pozisyon:** ").append(data.position).append("\n");
        for (String s : data.technicalSkills) {
            sb.append(matched.contains(s) ? "âœ… " : "âŒ ").append(s).append("\n");
        }
        return sb.toString();
    }

    private JobAiResult parseAiResult(String json) {
        JobAiResult result = new JobAiResult();
        try {
            JsonNode root = objectMapper.readTree(json);
            result.position = root.path("position").asText("BelirtilmemiÅŸ");
            result.summary = root.path("summary").asText("");
            JsonNode skillsNode = root.path("technicalSkills");
            if (skillsNode.isArray()) {
                skillsNode.forEach(n -> result.technicalSkills.add(n.asText()));
            }
        } catch (Exception e) { log.error("JSON Error", e); }
        return result;
    }

    private static class JobAiResult {
        public String position;
        public String summary;
        public List<String> technicalSkills = new ArrayList<>();
        public String company;
    }
}