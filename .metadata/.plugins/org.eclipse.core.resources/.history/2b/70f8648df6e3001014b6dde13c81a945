package com.cvbuilder.external;

import com.cvbuilder.dto.OptimizedCvItem;
import com.cvbuilder.dto.UserCertificateDTO;
import com.cvbuilder.dto.UserEducationDTO;
import com.cvbuilder.dto.UserLanguageDTO;
import com.cvbuilder.entity.JobPosting;
import com.cvbuilder.entity.UserProfile;
import com.cvbuilder.entity.UserSkill;
import com.cvbuilder.repository.JobPostingRepository;
import com.cvbuilder.service.TranslationService;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import java.util.*;
import java.util.stream.Collectors;

@Component
public class AiClient {

    private static final Logger log = LoggerFactory.getLogger(AiClient.class);

    private final TranslationService translationService;
    private final JobPostingRepository jobPostingRepository;

    @Autowired
    public AiClient(TranslationService translationService, JobPostingRepository jobPostingRepository) {
        this.translationService = translationService;
        this.jobPostingRepository = jobPostingRepository;
    }

    /**
     * BÄ°REYSEL Ä°Å ANALÄ°ZÄ°: Aday profili ile iÅŸ ilanÄ±nÄ± ATS kriterlerine gÃ¶re karÅŸÄ±laÅŸtÄ±rÄ±r.
     */
    public String analyzeJobSubmission(UserProfile user, String rawJobText) {
        String userContext = formatUserProfile(user);
        String jobText = safe(rawJobText);

        SEN DÃœNYA STANDARTLARINDA BÄ°R KIDEMLÄ° TEKNÄ°K RECRUITER VE STRATEJÄ°K Ä°Å ANALÄ°STÄ°SÄ°N.
        GÃ¶revin, adayÄ±n profilini bir bÃ¼yÃ¼teÃ§ altÄ±na alarak iÅŸ ilanÄ±yla "Semantik (Anlamsal)" bir karÅŸÄ±laÅŸtÄ±rma yapmaktÄ±r. 

        ### ANALÄ°Z TALÄ°MATLARI:
        1. **Derin KarÅŸÄ±laÅŸtÄ±rma:** Sadece anahtar kelime eÅŸleÅŸmesine bakma. AdayÄ±n iÅŸ deneyimlerindeki sorumluluklarÄ±nÄ±, iÅŸ ilanÄ±ndaki "Sorumluluklar" maddeleriyle eÅŸleÅŸtir. 
        2. **Kritiklik Seviyesi:** Ä°landaki teknolojileri "Kritik", "Destekleyici" ve "YumuÅŸak Beceriler" olarak sÄ±nÄ±flandÄ±r ve analizi buna gÃ¶re yap.
        3. **Dil ve KÃ¼ltÃ¼r:** AdayÄ±n dil seviyesinin (Ã–rn: B2), ilandaki teknik dÃ¶kÃ¼mantasyon okuma veya toplantÄ± yÃ¶netme ihtiyacÄ±nÄ± karÅŸÄ±layÄ±p karÅŸÄ±lamayacaÄŸÄ±nÄ± yorumla.
        4. **Ã‡Ä±karÄ±m Yap:** EÄŸer aday "Spring Boot" biliyorsa, onun "Microservices" ve "Java" ekosistemine hakim olduÄŸunu varsayarak yetkinlik skorunu buna gÃ¶re iÅŸle.

        ---
        ### Ã‡IKTI FORMATI:

        ### ğŸ“Š DetaylÄ± Teknik Uyumluluk Analizi
        - [Stratejik Yorum]: AdayÄ±n kariyer yolculuÄŸu bu pozisyonun evrimiyle ne kadar Ã¶rtÃ¼ÅŸÃ¼yor? (En az 5 cÃ¼mlelik, teknik derinliÄŸi olan bir paragraf).
        - [ATS PuanÄ± Tahmini]: 100 Ã¼zerinden bir uyum skoru ver ve nedenini aÃ§Ä±kla.

        ### âœ… EÅŸleÅŸen Teknik Yetkinlikler ve Deneyim Transferi
        - (AdayÄ±n sahip olduÄŸu bir yeteneÄŸin, ilandaki tam olarak hangi problemi Ã§Ã¶zeceÄŸini aÃ§Ä±kla. Ã–rn: "AdayÄ±n X projesindeki tecrÃ¼besi, ilandaki Y sisteminin kurulmasÄ± iÃ§in kritik Ã¶nemde.")
        - (En az 6 detaylÄ± madde)

        ### âš ï¸ Kritik Yetkinlik BoÅŸluklarÄ± ve Operasyonel Riskler
        - (Sadece eksik listesi deÄŸil; bu eksiÄŸin iÅŸe alÄ±m sonrasÄ± oryantasyon sÃ¼resini nasÄ±l etkileyeceÄŸini belirt.)
        - (En az 6 detaylÄ± madde)

        ### ğŸ’¡ MÃ¼lakat Ä°Ã§in Teknik Soru Ã–nerileri
        - (AdayÄ±n profilinde belirsiz kalan veya ilanda Ã§ok kritik olan noktalar iÃ§in adaya sorulmasÄ± gereken 3 teknik soru hazÄ±rla.)

        ### ğŸ¯ Teknik SonuÃ§ ve BaÅŸvuru Durumu
        - **DURUM:** [UYGUN / KISMEN UYGUN / RÄ°SKLÄ° / UYGUN DEÄÄ°L]
        - **GEREKÃ‡E:** (Verilere dayalÄ±, nihai profesyonel karar Ã¶zeti.)
        ---

        [Aday Profili]
        %s

        [Ä°ÅŸ Ä°lanÄ±]
        %s
                """.formatted(userContext, jobText);

        try {
            return translationService.generateContent(prompt);
        } catch (Exception e) {
            log.error("AI Analiz HatasÄ±: ", e);
            return "Analiz servisine ÅŸu anda ulaÅŸÄ±lamÄ±yor.";
        }
    }

    /**
     * PAZAR ANALÄ°ZÄ°: Belirli bir uzmanlÄ±k alanÄ± iÃ§in toplanan verileri adayÄ±n profiliyle kÄ±yaslar.
     */
    public String performMarketTrendAnalysis(String area, String aggregatedJobData, UserProfile userProfile) {
        String userContext = formatUserProfileForMarketAnalysis(userProfile);

        String prompt = """
            SEN ÃœST DÃœZEY BÄ°R TEKNOLOJÄ° PAZAR ANALÄ°STÄ° VE KARÄ°YER DANIÅMANISIN.
            AÅŸaÄŸÄ±daki veriler, veritabanÄ±nda bulunan son iÅŸ ilanlarÄ±ndan derlenmiÅŸtir.

            GÃ–REVÄ°N:
            1. '%s' alanÄ±yla ilgili tÃ¼m iÅŸ ilanlarÄ±nÄ± otomatik olarak tespit et
            2. Bu ilanlardaki beceri trendlerini analiz et
            3. AdayÄ±n mevcut profiliyle karÅŸÄ±laÅŸtÄ±r
            4. KiÅŸiselleÅŸtirilmiÅŸ geliÅŸim Ã¶nerileri sun

            Ã–NEMLÄ° KURALLAR:
            - Ä°lanlarÄ± sadece baÅŸlÄ±kla deÄŸil, iÃ§erikte geÃ§en teknoloji ve becerilere gÃ¶re filtrele
            - "Machine Learning" aranÄ±yorsa "Yapay Zeka", "AI", "Veri Bilimi" gibi ilgili terimleri de dikkate al
            - Ä°statistiksel analiz yap: "100 ilanÄ±n 85'inde Python gerekiyor (%85)"
            - Somut ve Ã¶lÃ§Ã¼lebilir Ã¶neriler sun

            Ã‡IKTI FORMATI (TÃœRKÃ‡E):

            ### ğŸ“Š GENEL PAZAR DURUMU
            - Toplam analiz edilen ilan sayÄ±sÄ±: [sayÄ±]
            - '%s' ile ilgili bulunan ilan sayÄ±sÄ±: [sayÄ±]
            - Pazar bÃ¼yÃ¼klÃ¼ÄŸÃ¼ ve talep eÄŸilimleri

            ### ğŸ”¥ EN Ã‡OK TALEP EDÄ°LEN 10 BECERÄ°
            1. [Beceri 1] - [%X] oranÄ±nda talep ediliyor
            2. [Beceri 2] - [%Y] oranÄ±nda talep ediliyor
            ...

            ### âœ… PROFÄ°LÄ°NÄ°ZLE EÅLEÅEN BECERÄ°LER
            - [Beceri 1]: Bu beceriye sahipsiniz - pazar deÄŸerinizi artÄ±rÄ±yor âœ“
            - [Beceri 2]: ...

            ### âš ï¸ KRÄ°TÄ°K EKSÄ°K BECERÄ°LERÄ°NÄ°Z
            - [Beceri 1]: %[X] talep oranÄ± - Ã–NCELÄ°KLÄ° Ã–ÄRENMENÄ°Z GEREKÄ°YOR
            - [Beceri 2]: %[Y] talep oranÄ± - Ã–NEMLÄ° BÄ°R EKSÄ°K
            ...

            ### ğŸ¯ SÄ°ZE Ã–ZEL GELÄ°ÅÄ°M YOL HARÄ°TASI
            - Ä°LK 3 AY: [En kritik 3 beceri]
            - 3-6 AY: [Orta vadeli hedefler]
            - 6-12 AY: [Uzun vadeli uzmanlaÅŸma]

            ### ğŸ’ SÄ°ZÄ° Ã–NE Ã‡IKARACAK "KILLER SKILLS"
            - [Niche beceri 1]: Neden Ã¶nemli?
            - [Niche beceri 2]: Rakiplerden farkÄ±nÄ±z

            ### ğŸ“š Ã–NERÄ°LEN Ã–ÄRENME KAYNAKLARI
            - [Beceri 1 iÃ§in]: [Kurs/Kaynak Ã¶nerisi]
            - [Beceri 2 iÃ§in]: [Kurs/Kaynak Ã¶nerisi]

            [TÃœM Ä°LAN VERÄ°LERÄ°]
            %s

            [ADAY PROFÄ°LÄ°]
            %s
            """.formatted(area, area, aggregatedJobData, userContext);

        try {
            return translationService.generateContent(prompt);
        } catch (Exception e) {
            log.error("Pazar Analizi HatasÄ±: ", e);
            return "Pazar analizi ÅŸu an gerÃ§ekleÅŸtirilemiyor.";
        }
    }

    public String formatAllJobPostingsForAI(List<JobPosting> allJobs) {
        StringBuilder sb = new StringBuilder();
        sb.append("TOPLAM Ä°LAN SAYISI: ").append(allJobs.size()).append("\n\n");

        for (int i = 0; i < Math.min(allJobs.size(), 100); i++) {
            JobPosting job = allJobs.get(i);
            sb.append("--- Ä°LAN ").append(i + 1).append(" ---\n");
            sb.append("POZÄ°SYON: ").append(safe(job.getPosition())).append("\n");
            sb.append("GEREKLÄ° BECERÄ°LER: ").append(safe(job.getRequiredSkills())).append("\n");
            String cleaned = safe(job.getCleanedText());
            sb.append("AÃ‡IKLAMA: ")
              .append(cleaned.substring(0, Math.min(500, cleaned.length())))
              .append("...\n\n");
        }

        return sb.toString();
    }

    private String formatUserProfileForMarketAnalysis(UserProfile user) {
        if (user == null) return "Profil bilgisi bulunamadÄ±.";

        StringBuilder sb = new StringBuilder();
        sb.append("=== TEMEL BÄ°LGÄ°LER ===\n");
        sb.append("BaÅŸlÄ±k/UzmanlÄ±k: ").append(safe(user.getTitle())).append("\n");
        if (user.getTotalExperienceYear() != null) {
            sb.append("Toplam Deneyim: ").append(user.getTotalExperienceYear()).append(" yÄ±l\n");
        }

        sb.append("\n=== TEKNÄ°K BECERÄ°LER ===\n");
        if (user.getSkills() != null && !user.getSkills().isEmpty()) {
            user.getSkills().forEach(skill -> sb.append("- ").append(safe(skill.getSkillName())).append("\n"));
        } else {
            sb.append("BelirtilmemiÅŸ\n");
        }

        sb.append("\n=== DÄ°L BÄ°LGÄ°SÄ° ===\n");
        if (user.getLanguages() != null && !user.getLanguages().isEmpty()) {
            user.getLanguages().forEach(lang -> sb.append("- ").append(safe(lang.getLanguage()))
                    .append(" (").append(safe(lang.getLevel())).append(")\n"));
        } else {
            sb.append("BelirtilmemiÅŸ\n");
        }

        sb.append("\n=== EÄÄ°TÄ°M ===\n");
        if (user.getEducations() != null && !user.getEducations().isEmpty()) {
            user.getEducations().forEach(edu -> sb.append("- ").append(safe(edu.getDepartment()))
                    .append(", ").append(safe(edu.getSchoolName()))
                    .append(" (").append(safe(edu.getDegree())).append(")\n"));
        } else {
            sb.append("BelirtilmemiÅŸ\n");
        }

        return sb.toString();
    }

    public String analyzeJobPostingUniversal(String rawJobText) {
        if (rawJobText == null) rawJobText = "";

        String prompt = String.format(
                "SEN KIDEMLI BIR TEKNIK RECRUITER + IS ANALISTISIN.\n" +
                "Asagidaki is ilanini analiz et ve SADECE JSON DONDUR.\n" +
                "JSON DISINDA HICBIR SEY YAZMA. Markdown yok. Kod blogu yok.\n\n" +
                "JSON SCHEMA:\n" +
                "{\n" +
                "  \"position\": \"...\",\n" +
                "  \"company\": \"...\",\n" +
                "  \"location\": \"...\",\n" +
                "  \"workType\": \"...\",\n" +
                "  \"experienceLevel\": \"...\",\n" +
                "  \"educationLevel\": \"...\",\n" +
                "  \"militaryStatus\": \"...\",\n" +
                "  \"languages\": [\"...\"],\n" +
                "  \"salary\": \"...\",\n" +
                "  \"summary\": \"...\",\n" +
                "  \"technicalSkills\": [\"...\"],\n" +
                "  \"responsibilities\": [\"...\"]\n" +
                "}\n\n" +
                "IS ILANI METNI:\n%s\n",
                rawJobText
        );

        try {
            String response = translationService.generateContent(prompt);
            if (response == null) return "{}";
            return response.replaceAll("```json|```", "").trim();
        } catch (Exception e) {
            log.error("AI JSON Analiz HatasÄ±: ", e);
            return "{}";
        }
    }

    public List<String> generateTailoredSummaries(UserProfile profile, String jobContext) {
        String rawTitle = profile != null ? safe(profile.getTitle()) : "Profesyonel";
        String userTitle = toTitleCase(rawTitle);
        String skills = getPrioritizedSkills(profile);
        int years = (profile != null && profile.getTotalExperienceYear() != null) ? profile.getTotalExperienceYear() : 0;

        List<String> summaries = new ArrayList<>();
        summaries.add(String.format("%s deneyime sahip bir %s olarak, %s alanlarÄ±ndaki yetkinliÄŸimle deÄŸer katmayÄ± hedefliyorum.",
                years > 0 ? years + " yÄ±l" : "Yeni mezun", userTitle, years > 0 ? skills : skills));

        try {
            String aiSummary = translationService.generateContent(String.format(
                    "Bir %s iÃ§in %d yÄ±l deneyimli, ÅŸu yeteneklere sahip: %s. Ã‡ok kÄ±sa, profesyonel bir CV Ã¶zet cÃ¼mlesi yaz (Max 2 cÃ¼mle).",
                    userTitle, years, skills
            ));
            if (aiSummary != null && !aiSummary.isBlank()) summaries.add(aiSummary.replace("\"", "").trim());
        } catch (Exception e) {
            log.warn("AI Ã–zet oluÅŸturulamadÄ±.");
        }

        return summaries;
    }

    public List<OptimizedCvItem> optimizeExperiences(UserProfile profile, JobPosting job) {
        if (profile == null || profile.getExperiences() == null) return Collections.emptyList();
        String jobSkills = (job != null) ? safe(job.getRequiredSkills()) : "";

        return profile.getExperiences().stream().map(exp -> {
            String desc = safe(exp.getDescription());
            if (desc.length() > 10) desc = fixGrammarStrict(desc);

            String matched = findIntersection(desc, jobSkills);
            if (!matched.isEmpty()) desc += " Bu gÃ¶revde " + matched + " yetkinliklerini aktif olarak kullandÄ±m.";

            return new OptimizedCvItem(
                    safe(exp.getPosition()),
                    safe(exp.getCompany()),
                    formatDateRange(exp.getStartDate(), exp.getEndDate()),
                    Collections.singletonList(desc)
            );
        }).collect(Collectors.toList());
    }

    public List<OptimizedCvItem> optimizeProjects(UserProfile profile, JobPosting job) {
        if (profile == null || profile.getProjects() == null) return Collections.emptyList();
        return profile.getProjects().stream().map(p -> new OptimizedCvItem(
                safe(p.getProjectName()), "Proje",
                formatDateRange(p.getStartDate(), (p.getIsOngoing() != null && p.getIsOngoing()) ? null : p.getEndDate()),
                Collections.singletonList(fixGrammarStrict(safe(p.getDescription())))
        )).collect(Collectors.toList());
    }

    public List<UserEducationDTO> optimizeEducation(UserProfile profile, JobPosting job) {
        if (profile == null || profile.getEducations() == null) return Collections.emptyList();
        return profile.getEducations().stream().map(e -> UserEducationDTO.builder()
                .id(e.getId())
                .schoolName(fixGrammarStrict(safe(e.getSchoolName())))
                .department(fixGrammarStrict(safe(e.getDepartment())))
                .degree(safe(e.getDegree()))
                .startYear(safe(e.getStartYear()))
                .graduationYear(e.getEndYear())
                .gpa(safe(e.getGpa()))
                .build()).collect(Collectors.toList());
    }

    public List<UserLanguageDTO> optimizeLanguages(UserProfile profile, JobPosting job) {
        if (profile == null || profile.getLanguages() == null) return Collections.emptyList();
        return profile.getLanguages().stream().map(l -> UserLanguageDTO.builder()
                .id(l.getId())
                .language(safe(l.getLanguage()))
                .level(safe(l.getLevel()))
                .build()).collect(Collectors.toList());
    }

    public List<UserCertificateDTO> optimizeCertificates(UserProfile profile, JobPosting job) {
        if (profile == null || profile.getCertificates() == null) return Collections.emptyList();
        return profile.getCertificates().stream().map(c -> UserCertificateDTO.builder()
                .id(c.getId())
                .name(safe(c.getName()))
                .issuer(safe(c.getIssuer()))
                .date(safe(c.getDate()))
                .url(safe(c.getUrl()))
                .build()).collect(Collectors.toList());
    }

    public String getCareerAdvice(String jobTitle) {
        if (jobTitle == null || jobTitle.isBlank()) return "Tavsiye oluÅŸturulamadÄ±.";
        String prompt = "Kariyer danÄ±ÅŸmanÄ± olarak '" + jobTitle + "' pozisyonu iÃ§in trendleri ve geliÅŸim Ã¶nerilerini TÃ¼rkÃ§e maddeler halinde yaz.";
        try {
            return translationService.generateContent(prompt);
        } catch (Exception e) {
            log.error("Kariyer Tavsiyesi HatasÄ±: ", e);
            return "Kariyer tavsiyesi ÅŸu an oluÅŸturulamÄ±yor.";
        }
    }

    public String analyzeMarketWithAI(String area, List<JobPosting> allJobs, UserProfile userProfile) {
        String allJobsFormatted = formatAllJobPostingsForAI(allJobs);
        String userContext = formatUserProfileForMarketAnalysis(userProfile);

        String prompt = """
            SEN ÃœST DÃœZEY BÄ°R TEKNOLOJÄ° PAZAR ANALÄ°STÄ°SÄ°N.
            AÅŸaÄŸÄ±da veritabanÄ±ndaki tÃ¼m iÅŸ ilanlarÄ± ve bir adayÄ±n profili var.

            GÃ–REVÄ°N:
            1. '%s' alanÄ±yla ilgili TÃœM iÅŸ ilanlarÄ±nÄ± BUL (sadece baÅŸlÄ±k deÄŸil, iÃ§erikteki becerilere gÃ¶re)
            2. Bu ilanlardaki BECERÄ° TRENDLERÄ°NÄ° analiz et
            3. AdayÄ±n mevcut becerileriyle KARÅILAÅTIR
            4. KiÅŸiselleÅŸtirilmiÅŸ GELÄ°ÅÄ°M YOL HARÄ°TASI oluÅŸtur

            [TÃœM Ä°LAN VERÄ°LERÄ°]
            %s

            [ADAY PROFÄ°LÄ°]
            %s
            """.formatted(area, allJobsFormatted, userContext);

        try {
            return translationService.generateContent(prompt);
        } catch (Exception e) {
            log.error("AI Pazar Analizi HatasÄ±: ", e);
            return "Pazar analizi ÅŸu an gerÃ§ekleÅŸtirilemiyor. LÃ¼tfen daha sonra tekrar deneyin.";
        }
    }

    public String getQuickMarketAnalysis(String area, List<JobPosting> relevantJobs, UserProfile userProfile) {
        String userContext = formatUserProfileForMarketAnalysis(userProfile);
        String jobsSummary = formatJobsSummaryForQuickAnalysis(relevantJobs);

        String prompt = """
            SEN BÄ°R KARÄ°YER KOÃ‡USUN.
            '%s' alanÄ±ndaki iÅŸ ilanlarÄ±nÄ± ve adayÄ±n profilini analiz et.

            [Ä°LAN Ã–ZETÄ°]
            %s

            [ADAY PROFÄ°LÄ°]
            %s
            """.formatted(area, jobsSummary, userContext);

        try {
            return translationService.generateContent(prompt);
        } catch (Exception e) {
            log.error("HÄ±zlÄ± Pazar Analizi HatasÄ±: ", e);
            return "HÄ±zlÄ± analiz ÅŸu an yapÄ±lamÄ±yor.";
        }
    }

    private String formatJobsSummaryForQuickAnalysis(List<JobPosting> jobs) {
        if (jobs == null || jobs.isEmpty()) return "Bu alanda ilan bulunamadÄ±.";

        StringBuilder sb = new StringBuilder();
        sb.append("Toplam Ä°lan: ").append(jobs.size()).append("\n\n");

        Map<String, Integer> skillFrequency = new HashMap<>();
        for (JobPosting job : jobs) {
            if (job.getRequiredSkills() != null) {
                String[] skills = job.getRequiredSkills().split("[,;]");
                for (String skill : skills) {
                    String trimmed = skill.trim();
                    if (!trimmed.isEmpty()) {
                        skillFrequency.put(trimmed, skillFrequency.getOrDefault(trimmed, 0) + 1);
                    }
                }
            }
        }

        sb.append("En Ã‡ok GeÃ§en Beceriler:\n");
        skillFrequency.entrySet().stream()
                .sorted((a, b) -> b.getValue().compareTo(a.getValue()))
                .limit(10)
                .forEach(entry -> {
                    double percentage = (entry.getValue() * 100.0) / jobs.size();
                    sb.append("- ").append(entry.getKey())
                      .append(": %").append(String.format("%.1f", percentage))
                      .append(" (").append(entry.getValue()).append(" ilan)\n");
                });

        return sb.toString();
    }

    private String formatUserProfile(UserProfile user) {
        if (user == null) return "Profil bilgisi bulunamadÄ±.";

        StringBuilder sb = new StringBuilder();
        sb.append("=== TEMEL BÄ°LGÄ°LER ===\n");
        sb.append("BaÅŸlÄ±k: ").append(safe(user.getTitle())).append("\n");
        if (user.getTotalExperienceYear() != null) sb.append("Toplam Deneyim: ").append(user.getTotalExperienceYear()).append(" yÄ±l\n");

        sb.append("\n=== ANALÄ°Z Ä°Ã‡Ä°N KRÄ°TÄ°K YETKÄ°NLÄ°KLER (TEKNÄ°K + DÄ°L) ===\n");
        List<String> combinedCapabilities = new ArrayList<>();

        if (user.getLanguages() != null && !user.getLanguages().isEmpty()) {
            user.getLanguages().stream()
                    .map(l -> "DÄ°L: " + safe(l.getLanguage()) + " (Seviye: " + safe(l.getLevel()) + ")")
                    .forEach(combinedCapabilities::add);
        }

        if (user.getSkills() != null) {
            user.getSkills().stream().map(UserSkill::getSkillName).forEach(combinedCapabilities::add);
        }
        sb.append(String.join(", ", combinedCapabilities)).append("\n");

        if (user.getExperiences() != null && !user.getExperiences().isEmpty()) {
            sb.append("\n=== DENEYÄ°M Ã–ZETÄ° ===\n");
            user.getExperiences().stream().limit(5).forEach(exp -> sb.append("- ").append(safe(exp.getPosition()))
                    .append(" @ ").append(safe(exp.getCompany()))
                    .append(" (").append(formatDateRange(exp.getStartDate(), exp.getEndDate())).append(")\n"));
        }

        if (user.getEducations() != null && !user.getEducations().isEmpty()) {
            sb.append("\n=== EÄÄ°TÄ°M ===\n");
            user.getEducations().forEach(edu -> sb.append("- ").append(safe(edu.getDepartment()))
                    .append(", ").append(safe(edu.getSchoolName()))
                    .append(" (").append(safe(edu.getDegree())).append(")\n"));
        }

        sb.append("\n=== EK BÄ°LGÄ°LER ===\n");
        String ms = safe(user.getMilitaryStatus());
        if (!ms.isBlank()) sb.append("Askerlik Durumu: ").append(ms).append("\n");

        return sb.toString();
    }

    private String getPrioritizedSkills(UserProfile profile) {
        if (profile == null || profile.getSkills() == null || profile.getSkills().isEmpty()) return "Mesleki Yetkinlikler";
        return profile.getSkills().stream().limit(5).map(UserSkill::getSkillName).collect(Collectors.joining(", "));
    }

    private String fixGrammarStrict(String text) {
        if (text == null || text.length() < 10) return text;
        try {
            String res = translationService.generateContent("AÅŸaÄŸÄ±daki metni anlamÄ±nÄ± bozmadan profesyonel bir dille ve imla kurallarÄ±na uygun olarak dÃ¼zelt: " + text);
            return res != null ? res.trim() : text;
        } catch (Exception e) {
            return text;
        }
    }

    private String findIntersection(String text, String skills) {
        if (text == null || skills == null || skills.isBlank()) return "";
        Set<String> match = new HashSet<>();
        String tLower = text.toLowerCase(new Locale("tr", "TR"));
        for (String s : skills.split("[,;]")) {
            String sTrim = s.trim().toLowerCase(new Locale("tr", "TR"));
            if (!sTrim.isEmpty() && tLower.contains(sTrim)) match.add(s.trim());
        }
        return String.join(", ", match);
    }

    private String toTitleCase(String input) {
        if (input == null || input.isEmpty()) return "";
        return Arrays.stream(input.trim().split("\\s+"))
                .map(w -> w.isEmpty() ? "" : Character.toUpperCase(w.charAt(0)) + w.substring(1).toLowerCase(new Locale("tr", "TR")))
                .collect(Collectors.joining(" "));
    }

    private String safe(String text) {
        return (text == null || text.equalsIgnoreCase("null")) ? "" : text.trim();
    }

    private String formatDateRange(String start, String end) {
        String s = (start != null && !start.isBlank()) ? start : "BelirtilmemiÅŸ";
        String e = (end != null && !end.isBlank()) ? end : "Devam Ediyor";
        return s + " - " + e;
    }
}
