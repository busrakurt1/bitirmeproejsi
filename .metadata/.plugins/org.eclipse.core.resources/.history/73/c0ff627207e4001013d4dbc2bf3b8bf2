package com.cvbuilder.external;

import org.jsoup.Connection;
import org.jsoup.Jsoup;
import org.jsoup.nodes.Document;
import org.jsoup.nodes.Element;
import org.jsoup.select.Elements;
import org.springframework.stereotype.Component;
import java.io.IOException;
import java.util.HashMap;
import java.util.Map;
import lombok.extern.slf4j.Slf4j;

@Slf4j
@Component
public class JobScraperClient {

    private static final Map<String, String[]> SITE_SELECTORS = new HashMap<>();
    
    static {
        // Kariyer.net iÃ§in GÃœNCELLENMÄ°Å selector'lar
        SITE_SELECTORS.put("kariyer.net", new String[]{
            // Ana iÃ§erik bÃ¶lÃ¼mleri (yeni yapÄ±)
            "section[data-testid='job-detail-content']",
            "div.job-detail-content",
            "div.job-description",
            "div.description-content",
            "div[class*='jobDetailContent']",
            "div[class*='jobDescription']",
            
            // Fallback selector'lar
            "main#mainContent",
            "article",
            "div.content",
            
            // Meta tag'lardan bilgi Ã§ekme
            "meta[name='description']",
            "meta[property='og:description']"
        });
        
        SITE_SELECTORS.put("linkedin.com", new String[]{
            ".description__text", 
            ".show-more-less-html__markup",
            ".jobs-description__content"
        });
    }

    public Map<String, String> fetchJobData(String url) {
        Map<String, String> result = new HashMap<>();
        log.info("ğŸŒ Ä°lan Ã§ekiliyor: {}", url);
        
        try {
            // Daha detaylÄ± header'lar ekleyelim
            Connection.Response response = Jsoup.connect(url)
                    .userAgent("Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.0.0 Safari/537.36 Edg/121.0.0.0")
                    .header("Accept-Language", "tr-TR,tr;q=0.9,en-US;q=0.8,en;q=0.7")
                    .header("Accept", "text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7")
                    .header("Accept-Encoding", "gzip, deflate, br")
                    .header("Cache-Control", "no-cache")
                    .header("Pragma", "no-cache")
                    .referrer("https://www.google.com/")
                    .ignoreHttpErrors(true)
                    .followRedirects(true)
                    .timeout(30000)
                    .maxBodySize(0) // SÄ±nÄ±rÄ± kaldÄ±r
                    .execute();

            Document doc = response.parse();
            result.put("pageTitle", doc.title());
            
            log.debug("ğŸ“„ Sayfa baÅŸlÄ±ÄŸÄ±: {}", doc.title());
            log.debug("ğŸ“„ Sayfa URL: {}", response.url());
            log.debug("ğŸ“„ Status Code: {}", response.statusCode());
            
            // Debug iÃ§in tÃ¼m meta tag'larÄ± loglayalÄ±m
            Elements allMeta = doc.select("meta");
            log.debug("ğŸ“Š Toplam meta tag sayÄ±sÄ±: {}", allMeta.size());
            
            // 1. Siteye Ã¶zel selector ile iÃ§erik Ã§ekme
            String jobContent = extractJobSpecificContent(doc, url);
            
            // 2. EÄŸer Ã¶zel iÃ§erik boÅŸsa veya Ã§ok kÄ±saysa yedek mekanizmalar
            if (jobContent == null || jobContent.trim().length() < 100) {
                log.warn("âš ï¸ Ã–zel selector sonuÃ§ vermedi, alternatif yÃ¶ntemler deneniyor...");
                
                // Alternatif 1: Ana iÃ§erik seÃ§imi
                jobContent = tryAlternativeSelectors(doc);
                
                // Alternatif 2: Meta description
                if (jobContent.length() < 100) {
                    jobContent = extractMetaDescription(doc);
                }
                
                // Alternatif 3: Body temizleme (son Ã§are)
                if (jobContent.length() < 100) {
                    jobContent = cleanBodyText(doc.body());
                }
                
                if (jobContent.length() < 50) {
                    log.error("âŒ TÃ¼m yÃ¶ntemler baÅŸarÄ±sÄ±z oldu. HTML yapÄ±sÄ±nÄ± debug edin.");
                    // HTML yapÄ±sÄ±nÄ± logla (ilk 5000 karakter)
                    log.debug("ğŸ” HTML Ã–nizleme:\n{}", doc.html().substring(0, Math.min(5000, doc.html().length())));
                }
            }

            result.put("jobContent", jobContent);
            result.put("location", extractFromMeta(doc, "location", "place", "og:description"));
            result.put("company", extractFromMeta(doc, "company", "organization", "og:title"));
            
            // Pozisyon bilgisini title'dan Ã§Ä±karmaya Ã§alÄ±ÅŸ
            result.put("position", extractPositionFromTitle(doc.title(), jobContent));
            
            log.info("âœ… Ä°lan iÃ§eriÄŸi baÅŸarÄ±yla Ã§ekildi (Karakter sayÄ±sÄ±: {})", jobContent.length());
            return result;

        } catch (IOException e) {
            log.error("âŒ Ä°lan Ã§ekme hatasÄ±: {}", e.getMessage(), e);
            throw new RuntimeException("Ä°lan verisi Ã§ekilemedi: " + e.getMessage());
        }
    }
    
    private String extractJobSpecificContent(Document doc, String url) {
        String domain = extractDomain(url);
        
        if (SITE_SELECTORS.containsKey(domain)) {
            for (String selector : SITE_SELECTORS.get(domain)) {
                try {
                    Elements elements = doc.select(selector);
                    if (!elements.isEmpty()) {
                        StringBuilder content = new StringBuilder();
                        for (Element element : elements) {
                            content.append(element.text()).append("\n\n");
                        }
                        log.debug("âœ… Selector bulundu: '{}' - {} element", selector, elements.size());
                        return content.toString().trim();
                    }
                } catch (Exception e) {
                    log.warn("âš ï¸ Selector hatasÄ± '{}': {}", selector, e.getMessage());
                }
            }
        }
        
        return "";
    }
    
    private String tryAlternativeSelectors(Document doc) {
        String[] altSelectors = {
            "div[class*='content']",
            "div[class*='detail']",
            "div[class*='description']",
            "section",
            "article",
            "div.main",
            "div.container",
            "div.wrapper"
        };
        
        for (String selector : altSelectors) {
            Elements elements = doc.select(selector);
            if (!elements.isEmpty()) {
                // BÃ¼yÃ¼k metin bloklarÄ±nÄ± filtrele
                for (Element element : elements) {
                    String text = element.text();
                    if (text.length() > 300) { // AnlamlÄ± iÃ§erik
                        log.debug("âœ… Alternatif selector bulundu: '{}' - {} karakter", selector, text.length());
                        return text;
                    }
                }
            }
        }
        
        return "";
    }
    
    private String extractMetaDescription(Document doc) {
        Element metaDesc = doc.select("meta[name=description]").first();
        if (metaDesc != null) {
            return metaDesc.attr("content");
        }
        
        Element ogDesc = doc.select("meta[property='og:description']").first();
        if (ogDesc != null) {
            return ogDesc.attr("content");
        }
        
        return "";
    }
    
    private String cleanBodyText(Element body) {
        if (body == null) return "";
        
        // Klon oluÅŸtur
        Element content = body.clone();
        
        // Gereksiz elementleri temizle
        String[] removeSelectors = {
            "nav", "header", "footer", "script", "style", 
            "iframe", "aside", ".nav", ".menu", ".sidebar", 
            ".ads", ".advertisement", ".footer", ".header",
            ".social", ".share", ".comment", ".modal",
            "link", "meta", "noscript", "svg", "path"
        };
        
        for (String selector : removeSelectors) {
            content.select(selector).remove();
        }
        
        // Metni al ve temizle
        String text = content.text();
        
        // Ã‡ok kÄ±sa satÄ±rlarÄ± ve gereksiz boÅŸluklarÄ± temizle
        text = text.replaceAll("(?m)^[ \\t\\x0B\\f]*$", "\n"); // BoÅŸ satÄ±rlarÄ± normalize et
        text = text.replaceAll("\\s+", " "); // Fazla boÅŸluklarÄ± temizle
        
        return text.trim();
    }
    
    private String extractFromMeta(Document doc, String... keys) {
        for (String key : keys) {
            Element meta = doc.select("meta[name=" + key + "], meta[property=" + key + "]").first();
            if (meta != null) {
                String content = meta.attr("content");
                if (content != null && !content.trim().isEmpty()) {
                    return content;
                }
            }
        }
        return "";
    }
    
    private String extractPositionFromTitle(String title, String content) {
        // Title'dan pozisyon Ã§Ä±karmaya Ã§alÄ±ÅŸ
        if (title != null && title.contains("|")) {
            return title.split("\\|")[0].trim();
        }
        
        // Ä°Ã§erikten anahtar kelimeler ara
        String[] keywords = {"stajyer", "developer", "mÃ¼hendis", "uzman", "analist", "yÃ¶netici"};
        for (String keyword : keywords) {
            if (content.toLowerCase().contains(keyword)) {
                return keyword.substring(0, 1).toUpperCase() + keyword.substring(1);
            }
        }
        
        return "BelirtilmemiÅŸ";
    }
    
    private String extractDomain(String url) {
        try {
            java.net.URL uri = new java.net.URL(url);
            String host = uri.getHost();
            if (host.startsWith("www.")) {
                host = host.substring(4);
            }
            
            // Ana domain'i al (subdomain'leri kaldÄ±r)
            for (Map.Entry<String, String[]> entry : SITE_SELECTORS.entrySet()) {
                if (host.contains(entry.getKey())) {
                    return entry.getKey();
                }
            }
            
            return host;
        } catch (Exception e) {
            return url;
        }
    }
}