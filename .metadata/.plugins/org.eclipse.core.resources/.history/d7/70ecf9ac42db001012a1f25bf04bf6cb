package com.cvbuilder.external;

import com.cvbuilder.dto.*;
import com.cvbuilder.entity.*;
import com.cvbuilder.repository.JobPostingRepository;
import com.cvbuilder.service.TranslationService;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import java.util.*;
import java.util.stream.Collectors;

@Component
public class AiClient {

    private static final Logger log = LoggerFactory.getLogger(AiClient.class);
    private final TranslationService translationService;
    private final JobPostingRepository jobPostingRepository;

    @Autowired
    public AiClient(TranslationService translationService, JobPostingRepository jobPostingRepository) {
        this.translationService = translationService;
        this.jobPostingRepository = jobPostingRepository;
    }

    // =========================================================
    // ðŸŒŸ 1. ANA ANALÄ°Z METODU (GÃœNCELLENMÄ°Åž & TAM KAPSAMLI)
    // =========================================================
    public String analyzeJobSubmission(UserProfile user, String rawJobText) {
        String userContext = formatUserProfileFull(user);

        String prompt = String.format(
            "SEN BÄ°R Ä°K UZMANI VE TEKNÄ°K ANALÄ°STSÄ°N.\n" +
            "AÅŸaÄŸÄ±daki Ä°Åž Ä°LANI ile ADAY PROFÄ°LÄ°NÄ° karÅŸÄ±laÅŸtÄ±r ve analiz et.\n\n" +
            "--- TAM ADAY PROFÄ°LÄ° ---\n%s\n\n" +
            "--- Ä°Åž Ä°LANI ---\n%s\n\n" +
            "GÃ–REVLER:\n" +
            "1. Ä°lanÄ±n temel bilgilerini Ã§Ä±kar (Firma, Pozisyon, Konum, Ã‡alÄ±ÅŸma Tipi)\n" +
            "2. AdayÄ±n TÃœM Ã¶zelliklerini ilanla kÄ±yasla (Teknik Yetenekler, Diller, EÄŸitim, Askerlik, Konum, Deneyim).\n" +
            "âš ï¸ DÄ°L KURALI: AdayÄ±n profilindeki diller ilandakilerle eÅŸleÅŸiyorsa (bÃ¼yÃ¼k/kÃ¼Ã§Ã¼k harf bakmaksÄ±zÄ±n) bunu KESÄ°NLÄ°KLE 'Mevcut' iÅŸaretle.\n" +
            "3. EÅŸleÅŸen ve eksik olanlarÄ± belirle.\n\n" +
            "Ä°STENEN Ã‡IKTI FORMATI:\n" +
            "## ðŸ“‹ POZÄ°SYON ANALÄ°ZÄ°\n" +
            "**ðŸ¢ Firma:** (Firma AdÄ±)\n" +
            "**ðŸ“‹ Pozisyon:** (Ä°lan BaÅŸlÄ±ÄŸÄ± + Seviye)\n" +
            "**ðŸ“ Konum:** (Åžehir/Ä°lÃ§e)\n" +
            "**ðŸ’¼ Ã‡alÄ±ÅŸma Tipi:** (Tam ZamanlÄ±/Hibrit/Uzaktan)\n\n" +
            "## ðŸŽ¯ PROFÄ°L EÅžLEÅžME DURUMU\n" +
            "### ðŸ›  Teknik Yetenekler\n" +
            "- âœ… [Adayda Olan Yetenek]\n" +
            "- âŒ **[Adayda Eksik Yetenek]**\n" +
            "### ðŸŒ Diller\n" +
            "- âœ… [Adayda Olan Dil]\n" +
            "- âŒ **[Ä°landa Ä°stenen Adayda Olmayan Dil]**\n" +
            "### ðŸŽ“ EÄŸitim\n" +
            "- %s\n" +
            "### ðŸŽ– Askerlik\n" +
            "- %s\n" +
            "### ðŸ“ Konum\n" +
            "- Aday Åžehri: %s | Ä°lan Konumu: (Ä°landan Ã‡Ä±kar)\n" +
            "### ðŸ“‹ Ä°ÅŸ SorumluluklarÄ±\n" +
            "%s\n\n" +
            "## ðŸ“Š GENEL DEÄžERLENDÄ°RME\n" +
            "(KÄ±sa bir deÄŸerlendirme paragrafÄ± yaz)",
            userContext,
            rawJobText,
            formatEducationInfo(user),
            formatMilitaryInfo(user),
            user.getCity() != null ? user.getCity() : "BelirtilmemiÅŸ",
            formatResponsibilities(user, rawJobText)
        );

        try {
            return translationService.generateContent(prompt);
        } catch (Exception e) {
            log.error("AI Analiz HatasÄ±: ", e);
            return "Analiz servisine ulaÅŸÄ±lamadÄ±.";
        }
    }

    // =========================================================
    // ðŸŒŸ 2. TAM PROFÄ°L FORMATLAMA (VERÄ° HAZIRLAMA)
    // =========================================================
    private String formatUserProfileFull(UserProfile user) {
        if (user == null) return "Anonim KullanÄ±cÄ±";
        
        StringBuilder sb = new StringBuilder();
        sb.append("ðŸ‘¤ TEMEL BÄ°LGÄ°LER\n")
          .append("Ad Soyad: ").append(safe(user.getFullName())).append("\n")
          .append("Unvan: ").append(safe(user.getTitle())).append("\n")
          .append("Åžehir: ").append(safe(user.getCity())).append("\n")
          .append("Toplam Deneyim: ").append(user.getTotalExperienceYear() != null ? user.getTotalExperienceYear() + " YÄ±l" : "BelirtilmemiÅŸ").append("\n\n");

        if (user.getSkills() != null && !user.getSkills().isEmpty()) {
            sb.append("ðŸ›  TEKNÄ°K YETENEKLER: ")
              .append(user.getSkills().stream().map(UserSkill::getSkillName).collect(Collectors.joining(", ")))
              .append("\n\n");
        }

        if (user.getLanguages() != null && !user.getLanguages().isEmpty()) {
            sb.append("ðŸŒ YABANCI DÄ°LLER\n");
            user.getLanguages().forEach(l -> sb.append("- ").append(l.getLanguage()).append(" (").append(l.getLevel()).append(")\n"));
            sb.append("\n");
        }

        if (user.getEducations() != null && !user.getEducations().isEmpty()) {
            sb.append("ðŸŽ“ EÄžÄ°TÄ°M\n");
            user.getEducations().forEach(e -> sb.append("- ").append(e.getSchoolName()).append(" | ").append(e.getDegree()).append("\n"));
            sb.append("\n");
        }

        sb.append("ðŸŽ– ASKERLÄ°K: ").append(formatMilitaryInfo(user)).append("\n\n");

        if (user.getExperiences() != null && !user.getExperiences().isEmpty()) {
            sb.append("ðŸ’¼ DENEYÄ°MLER\n");
            user.getExperiences().forEach(exp -> {
                sb.append("## ").append(exp.getPosition()).append(" @ ").append(exp.getCompany()).append("\n")
                  .append("AÃ§Ä±klama: ").append(safe(exp.getDescription())).append("\n");
            });
        }

        return sb.toString();
    }

    // =========================================================
    // ðŸŒŸ 3. CV OPTÄ°MÄ°ZASYON VE DTO METOTLARI
    // =========================================================

    public List<String> generateTailoredSummaries(UserProfile profile, String jobContext) {
        String userTitle = toTitleCase(profile != null ? safe(profile.getTitle()) : "Profesyonel");
        String skills = getPrioritizedSkills(profile, jobContext);
        int years = (profile != null && profile.getTotalExperienceYear() != null) ? profile.getTotalExperienceYear() : 0;

        List<String> summaries = new ArrayList<>();
        summaries.add(String.format("%s deneyime sahip bir %s olarak, **%s** alanlarÄ±ndaki yetkinliÄŸimle deÄŸer katmayÄ± hedefliyorum.", 
            years > 0 ? years + " yÄ±l" : "Yeni mezun", userTitle, skills));
        
        String aiSummary = generateCreativeAiSummary(userTitle, skills, years);
        if (!aiSummary.isEmpty()) summaries.add(aiSummary);
        return summaries;
    }

    public List<OptimizedCvItem> optimizeExperiences(UserProfile profile, JobPosting job) {
        if (profile == null || profile.getExperiences() == null) return Collections.emptyList();
        String jobSkills = (job != null) ? safe(job.getRequiredSkills()) : "";

        return profile.getExperiences().stream().map(exp -> {
            String desc = safe(exp.getDescription());
            if (desc.length() > 10) desc = fixGrammarStrict(desc);
            String matched = findIntersection(desc, jobSkills);
            if (!matched.isEmpty()) desc += " Bu gÃ¶revde **" + matched + "** yetkinliklerini kullandÄ±m.";
            
            return new OptimizedCvItem(safe(exp.getPosition()), safe(exp.getCompany()), 
                    formatDateRange(exp.getStartDate(), exp.getEndDate()), List.of(desc));
        }).collect(Collectors.toList());
    }

    public List<UserEducationDTO> optimizeEducation(UserProfile profile, JobPosting job) {
        if (profile == null || profile.getEducations() == null) return Collections.emptyList();
        return profile.getEducations().stream().map(e -> UserEducationDTO.builder()
                .id(e.getId()).schoolName(fixGrammarStrict(safe(e.getSchoolName())))
                .department(safe(e.getDepartment())).degree(safe(e.getDegree()))
                .startYear(safe(e.getStartYear())).graduationYear(e.getEndYear()).gpa(safe(e.getGpa())).build())
                .collect(Collectors.toList());
    }

    // =========================================================
    // ðŸŒŸ 4. YARDIMCI VE ANALÄ°Z ARAÃ‡LARI
    // =========================================================

    private String formatEducationInfo(UserProfile user) {
        if (user == null || user.getEducations() == null || user.getEducations().isEmpty()) return "BelirtilmemiÅŸ";
        UserEducation latest = user.getEducations().stream()
                .max(Comparator.comparing(UserEducation::getStartYear)).orElse(user.getEducations().get(0));
        return String.format("%s - %s (%s)", latest.getSchoolName(), latest.getDepartment(), latest.getDegree());
    }

    private String formatMilitaryInfo(UserProfile user) {
        if (user == null || user.getMilitaryService() == null) return "BelirtilmemiÅŸ";
        String status = user.getMilitaryService().getStatus();
        return switch (status) {
            case "YAPILDI" -> "YapÄ±ldÄ± (" + safe(user.getMilitaryService().getDate()) + ")";
            case "TECÄ°LLÄ°" -> "Tecilli";
            case "MUAF" -> "Muaf";
            default -> status;
        };
    }

    private String formatResponsibilities(UserProfile user, String jobText) {
        StringBuilder sb = new StringBuilder("### Ä°landaki Beklenen Sorumluluklar:\n");
        try {
            String aiResponse = translationService.generateContent("Åžu ilandan gÃ¶revleri maddelerle Ã§Ä±kar: " + jobText);
            sb.append(aiResponse != null ? aiResponse : "Ã‡Ä±karÄ±lamadÄ±.");
        } catch (Exception e) { sb.append("Analiz hatasÄ±."); }
        return sb.toString();
    }

    public double calculateSkillMatchScore(UserProfile user, String jobText) {
        if (user.getSkills() == null || user.getSkills().isEmpty()) return 0.0;
        try {
            String aiSkills = translationService.generateContent("Ä°landaki teknik yetenekleri virgÃ¼lle ayÄ±r: " + jobText);
            if (aiSkills == null) return 0.0;
            Set<String> userSkills = user.getSkills().stream().map(s -> s.getSkillName().toLowerCase()).collect(Collectors.toSet());
            List<String> jobSkills = Arrays.asList(aiSkills.toLowerCase().split(","));
            long matchCount = jobSkills.stream().filter(js -> userSkills.contains(js.trim())).count();
            return (double) matchCount / jobSkills.size() * 100;
        } catch (Exception e) { return 0.0; }
    }

    private String fixGrammarStrict(String text) {
        if (text == null || text.length() < 10) return text;
        try {
            String res = translationService.generateContent("DÃ¼zgÃ¼n profesyonel TÃ¼rkÃ§e ile dÃ¼zelt: " + text);
            return res != null ? res.trim() : text;
        } catch (Exception e) { return text; }
    }

    private String findIntersection(String text, String skills) {
        if (text == null || skills == null) return "";
        Set<String> match = new HashSet<>();
        String tLower = text.toLowerCase(Locale.ENGLISH);
        for (String s : skills.split("[,;]")) {
            if (tLower.contains(s.trim().toLowerCase(Locale.ENGLISH))) match.add(s.trim());
        }
        return String.join(", ", match);
    }

    private String getPrioritizedSkills(UserProfile profile, String jobContext) {
        if (profile == null || profile.getSkills() == null) return "Mesleki Yetkinlikler";
        return profile.getSkills().stream().limit(5).map(UserSkill::getSkillName).collect(Collectors.joining(", "));
    }

    private String toTitleCase(String input) {
        if (input == null || input.isEmpty()) return "";
        return Arrays.stream(input.trim().split("\\s+"))
                .map(w -> w.isEmpty() ? "" : Character.toUpperCase(w.charAt(0)) + w.substring(1).toLowerCase(Locale.forLanguageTag("tr")))
                .collect(Collectors.joining(" "));
    }

    private String generateCreativeAiSummary(String title, String skills, int years) {
        try {
            return translationService.generateContent(String.format("%s unvanlÄ±, %d yÄ±l deneyimli biri iÃ§in %s yeteneklerini iÃ§eren profesyonel CV Ã¶zeti yaz.", title, years, skills));
        } catch (Exception e) { return ""; }
    }

    private String safe(String text) { return text != null ? text : ""; }

    private String formatDateRange(String start, String end) {
        return (start != null ? start : "") + (end != null ? " - " + end : " - Devam Ediyor");
    }
}