package com.cvbuilder.external;

import org.jsoup.Connection;
import org.jsoup.Jsoup;
import org.jsoup.nodes.Document;
import org.jsoup.nodes.Element;
import org.jsoup.select.Elements;
import org.springframework.stereotype.Component;

import java.io.IOException;
import java.util.HashMap;
import java.util.Map;

@Component
public class JobScraperClient {

    private static final Map<String, String[]> SITE_SELECTORS = new HashMap<>();

    static {
        SITE_SELECTORS.put("kariyer.net", new String[]{
                "#job-detail > div:nth-child(1) > div > div:nth-child(2)",
                "div[class*='job-detail']",
                "section.job-detail-content"
        });

        SITE_SELECTORS.put("linkedin.com", new String[]{
                ".description__text",
                ".show-more-less-html__markup",
                ".jobs-description__content"
        });

        SITE_SELECTORS.put("yenibiris.com", new String[]{
                ".job-detail-content",
                ".detail-text"
        });

        SITE_SELECTORS.put("eleman.net", new String[]{
                ".ilanDetay",
                "#jobDetail"
        });
    }

    public Map<String, String> fetchJobData(String url) {
        Map<String, String> result = new HashMap<>();

        try {
            Connection.Response response = Jsoup.connect(url)
                    // ---- Daha gerçekçi header seti ----
                    .userAgent("Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.0.0 Safari/537.36")
                    .header("Accept", "text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8")
                    .header("Accept-Language", "tr-TR,tr;q=0.9,en-US;q=0.8,en;q=0.7")
                    .header("Accept-Encoding", "gzip, deflate, br")
                    .header("Connection", "keep-alive")
                    .header("Upgrade-Insecure-Requests", "1")
                    .header("Sec-Fetch-Site", "none")
                    .header("Sec-Fetch-Mode", "navigate")
                    .header("Sec-Fetch-User", "?1")
                    .header("Sec-Fetch-Dest", "document")
                    .referrer("https://www.google.com/")
                    .followRedirects(true)
                    .ignoreHttpErrors(true)
                    .timeout(25000)
                    .execute();

            int status = response.statusCode();
            result.put("httpStatus", String.valueOf(status));
            result.put("finalUrl", response.url().toString());

            Document doc = response.parse();

            // 1) Başlık
            String pageTitle = safe(doc.title());
            result.put("pageTitle", pageTitle);

            // 2) Engellendik mi? (Kariyer.net logunda gördüğümüz durum)
            if (looksBlocked(pageTitle, doc)) {
                result.put("blocked", "true");
                result.put("blockReason", "Access denied / bot protection olabilir");
                // Bu durumda içerikler boş kalır; yine de fullText vs koyuyoruz.
            } else {
                result.put("blocked", "false");
            }

            // 3) Siteye özel selector ile içerik
            String jobContent = extractJobSpecificContent(doc, url);
            result.put("jobContent", safe(jobContent));

            // 4) Meta
            result.put("location", safe(extractFromMeta(doc, "location", "place")));
            result.put("company", safe(extractFromMeta(doc, "company", "organization")));

            // 5) JSON-LD
            String structuredData = extractStructuredData(doc);
            result.put("structuredData", safe(structuredData));

            // 6) Fallback fullText
            String fullText = doc.body() != null ? doc.body().text() : "";
            result.put("fullText", safe(fullText));

            return result;

        } catch (IOException e) {
            throw new RuntimeException("İlan çekilemedi: " + e.getMessage());
        }
    }

    private boolean looksBlocked(String title, Document doc) {
        String t = safe(title).toLowerCase();
        if (t.contains("access to this page has been denied")) return true;
        if (t.contains("access denied")) return true;
        if (t.contains("denied")) return true;

        // body içinde tipik blok mesajları
        String bodyText = (doc.body() != null) ? doc.body().text().toLowerCase() : "";
        return bodyText.contains("access to this page has been denied")
                || bodyText.contains("access denied")
                || bodyText.contains("robot")
                || bodyText.contains("bot")
                || bodyText.contains("captcha");
    }

    private String extractJobSpecificContent(Document doc, String url) {
        // Site bazlı selector denenmesi
        for (Map.Entry<String, String[]> entry : SITE_SELECTORS.entrySet()) {
            if (url.contains(entry.getKey())) {
                for (String selector : entry.getValue()) {
                    Elements elements = doc.select(selector);
                    if (!elements.isEmpty()) {
                        StringBuilder content = new StringBuilder();
                        for (Element el : elements) {
                            content.append(el.text()).append("\n");
                        }
                        return content.toString();
                    }
                }
            }
        }

        // Fallback: ilanla ilgili olabilecek bölümler
        Elements likelySections = doc.select(
                "div[class*='job'], " +
                        "div[class*='detail'], " +
                        "div[class*='description'], " +
                        "section[class*='content'], " +
                        "div[class*='position'], " +
                        "div[class*='requirement']"
        );

        if (!likelySections.isEmpty()) {
            StringBuilder content = new StringBuilder();
            for (Element el : likelySections) {
                String text = el.text().toLowerCase();
                if (text.contains("aranan") || text.contains("sorumluluk") ||
                        text.contains("nitelik") || text.contains("beceri") ||
                        text.contains("tecrübe") || text.contains("yetenek")) {
                    content.append(el.text()).append("\n");
                }
            }
            if (content.length() > 100) return content.toString();
        }

        // Son çare: body temizle
        return cleanBodyText(doc.body());
    }

    private String cleanBodyText(Element body) {
        if (body == null) return "";
        body.select("nav, header, footer, script, style, iframe, .nav, .menu, .sidebar").remove();
        return body.text();
    }

    private String extractFromMeta(Document doc, String... keys) {
        for (String key : keys) {
            Element meta = doc.select("meta[name=" + key + "], meta[property=" + key + "]").first();
            if (meta != null) return meta.attr("content");
        }
        return "";
    }

    private String extractStructuredData(Document doc) {
        Elements scripts = doc.select("script[type='application/ld+json']");
        for (Element script : scripts) {
            String html = script.html();
            if (html.contains("\"@type\":\"JobPosting\"") || html.contains("\"@type\": \"JobPosting\"")) {
                return html;
            }
        }
        return "";
    }

    private String safe(String s) {
        return (s == null || s.equalsIgnoreCase("null")) ? "" : s.trim();
    }
}
