package com.cvbuilder.external;

import com.cvbuilder.entity.JobPosting;
import com.cvbuilder.entity.UserProfile;
import com.cvbuilder.service.TranslationService;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Component;
import java.util.*;
import java.util.stream.Collectors;

@Slf4j
@Component
@RequiredArgsConstructor
public class AiClient {

    private final TranslationService translationService;

    /**
     * BÄ°REYSEL EÅLEÅME ANALÄ°ZÄ°: AdayÄ±n profilini tek bir iÅŸ ilanÄ±yla karÅŸÄ±laÅŸtÄ±rÄ±r.
     */
    public String analyzeJobSubmission(UserProfile user, String rawJobText) {
        String userContext = formatUserProfile(user);
        
        String prompt = String.format("""
            SEN KIDEMLÄ° BÄ°R TEKNÄ°K RECRUITER'SIN. 
            GÃ¶revin, adayÄ±n profili ile iÅŸ ilanÄ±nÄ± karÅŸÄ±laÅŸtÄ±rÄ±p profesyonel bir rapor sunmaktÄ±r.
            
            ADAY PROFÄ°LÄ°:
            %s
            
            Ä°Å Ä°LANI:
            %s
            
            LÃ¼tfen ÅŸu formatta cevap ver:
            ### ğŸ“Š Uyumluluk Ã–zeti
            (Genel bir paragraf)
            
            ### âœ… EÅŸleÅŸen Kritik Yetenekler
            - (Ä°landaki ihtiyacÄ± karÅŸÄ±layan yetenekleriniz)
            
            ### âš ï¸ GeliÅŸim AlanlarÄ± ve Eksikler
            - (AdayÄ±n bu iÅŸ iÃ§in Ã¶ÄŸrenmesi gerekenler)
            
            ### ğŸ¯ MÃ¼lakat Tavsiyesi
            - (Bu aday mÃ¼lakata girerse hangi konularda hazÄ±rlÄ±klÄ± olmalÄ±?)
            """, userContext, rawJobText);

        try {
            return translationService.generateContent(prompt);
        } catch (Exception e) {
            log.error("Ä°ÅŸ Analiz AI HatasÄ±: ", e);
            return "Analiz ÅŸu an yapÄ±lamÄ±yor.";
        }
    }

    /**
     * PAZAR TREND ANALÄ°ZÄ°: Sistemdeki tÃ¼m ilanlarÄ± tarayÄ±p "En Ã‡ok Ä°stenenleri" Ã§Ä±karÄ±r.
     */
    public String analyzeMarketWithAI(String area, List<JobPosting> allJobs, UserProfile userProfile) {
        String allJobsData = formatAllJobPostingsForAI(allJobs);
        String userContext = formatUserProfile(userProfile);

        String prompt = String.format("""
            SEN BÄ°R TEKNOLOJÄ° PAZAR ANALÄ°STÄ°SÄ°N.
            AÅŸaÄŸÄ±daki veriler sistemdeki gerÃ§ek iÅŸ ilanlarÄ±ndan toplanmÄ±ÅŸtÄ±r.
            
            HEDEF ALAN: %s
            
            Ä°Å Ä°LANLARI VERÄ°SÄ°:
            %s
            
            ADAY PROFÄ°LÄ°:
            %s
            
            GÃ–REVÄ°N:
            1. Hedef alandaki en popÃ¼ler 10 teknolojiyi belirle.
            2. AdayÄ±n bu pazar trendinin neresinde olduÄŸunu analiz et.
            3. KiÅŸiselleÅŸtirilmiÅŸ bir Ã¶ÄŸrenme yol haritasÄ± sun.
            
            Ã‡IKTI FORMATI:
            ### ğŸ”¥ Pazar Trendleri (En Ã‡ok Ä°stenenler)
            - [Teknoloji]: %%[Talep OranÄ±]
            
            ### ğŸ“‰ Profiliniz ve Pazar Uyumu
            (Analiz paragrafÄ±)
            
            ### ğŸš€ 6 AylÄ±k GeliÅŸim PlanÄ±
            - [Ay 1-2]: ...
            """, area != null ? area : "Genel", allJobsData, userContext);

        try {
            return translationService.generateContent(prompt);
        } catch (Exception e) {
            log.error("Pazar Analiz AI HatasÄ±: ", e);
            return "Pazar trendleri ÅŸu an analiz edilemiyor.";
        }
    }

    public String analyzeJobPostingUniversal(String rawJobText) {
        String prompt = String.format("""
            AÅŸaÄŸÄ±daki iÅŸ ilanÄ±nÄ± analiz et ve SADECE JSON dÃ¶ndÃ¼r.
            {
              "position": "...",
              "company": "...",
              "technicalSkills": ["skill1", "skill2"],
              "summary": "..."
            }
            METÄ°N: %s
            """, rawJobText);

        try {
            String response = translationService.generateContent(prompt);
            return response != null ? response.replaceAll("```json|```", "").trim() : "{}";
        } catch (Exception e) { return "{}"; }
    }

    // YARDIMCI FORMATLAMA METOTLARI
    private String formatUserProfile(UserProfile user) {
        if (user == null) return "Profil bulunamadÄ±.";
        StringBuilder sb = new StringBuilder();
        sb.append("Unvan: ").append(user.getTitle()).append("\n");
        sb.append("Beceriler: ");
        if (user.getSkills() != null) {
            user.getSkills().forEach(s -> sb.append(s.getSkillName()).append(", "));
        }
        return sb.toString();
    }

    private String formatAllJobPostingsForAI(List<JobPosting> allJobs) {
        StringBuilder sb = new StringBuilder();
        for (JobPosting job : allJobs) {
            sb.append("- ").append(job.getPosition()).append(": ").append(job.getRequiredSkills()).append("\n");
        }
        return sb.toString();
    }
}