package com.cvbuilder.controller;

import com.cvbuilder.dto.UserDTO;
import com.cvbuilder.dto.UserRequest;
import com.cvbuilder.service.UserService;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@Slf4j
@RestController
@RequestMapping("/api/users") // ðŸ”´ api.js'teki baseURL ile uyumlu: http://localhost:8080/api
@RequiredArgsConstructor
public class UserController {

    private final UserService userService;

    // âœ… TÃ¼m kullanÄ±cÄ±larÄ± getir (GET /api/users)
    @GetMapping
    public ResponseEntity<List<UserDTO>> getAllUsers() {
        List<UserDTO> users = userService.getAllUsers();
        return ResponseEntity.ok(users);
    }

    // âœ… Tek kullanÄ±cÄ± profili getir (GET /api/users/{id})
    // Profile.jsx ilk aÃ§Ä±lÄ±ÅŸta bunu Ã§aÄŸÄ±rmalÄ±
    @GetMapping("/{id}")
    public ResponseEntity<UserDTO> getUserById(@PathVariable Long id) {
        UserDTO user = userService.getUserProfile(id);
        return ResponseEntity.ok(user);
    }

    // âœ… Yeni kullanÄ±cÄ± oluÅŸtur (POST /api/users)
    // Ä°stersen register'Ä± buradan da yapabilirsin
    @PostMapping
    public ResponseEntity<UserDTO> createUser(@RequestBody UserRequest userRequest) {
        UserDTO created = userService.registerUser(userRequest);
        return ResponseEntity.ok(created);
    }

    // âœ… KullanÄ±cÄ± profilini gÃ¼ncelle (PUT /api/users/{id})
    // Profile.jsx -> userAPI.updateUser(id, userRequest) buraya vuracak
    @PutMapping("/{id}")
    public ResponseEntity<UserDTO> updateUser(
            @PathVariable Long id,
            @RequestBody UserRequest userRequest
    ) {
        UserDTO updated = userService.updateUserProfile(id, userRequest);
        return ResponseEntity.ok(updated);
    }
    
    @GetMapping("/user/{userId}/latest")
    public ResponseEntity<JobPosting> getLatestJob(@PathVariable Long userId) {
        JobPosting job = jobAnalysisService.getLatestJobByUser(userId);
        return ResponseEntity.ok(job);
    }

    // âœ… KullanÄ±cÄ± sil (DELETE /api/users/{id})
    @DeleteMapping("/{id}")
    public ResponseEntity<Void> deleteUser(@PathVariable Long id) {
        userService.deleteUser(id);
        return ResponseEntity.noContent().build();
    }

    // âœ… Email var mÄ± kontrolÃ¼ (GET /api/users/check-email?email=...)
    @GetMapping("/check-email")
    public ResponseEntity<Boolean> checkEmail(@RequestParam String email) {
        boolean exists = userService.existsByEmail(email);
        return ResponseEntity.ok(exists);
    }

    // âœ… Health endpoint (GET /api/users/health)
    @GetMapping("/health")
    public ResponseEntity<String> health() {
        return ResponseEntity.ok("USERS OK");
    }
}
