package com.cvbuilder.external;

import com.cvbuilder.dto.OptimizedCvItem;
import com.cvbuilder.dto.UserCertificateDTO;
import com.cvbuilder.dto.UserEducationDTO;
import com.cvbuilder.dto.UserLanguageDTO;
import com.cvbuilder.entity.JobPosting;
import com.cvbuilder.entity.UserProfile;
import com.cvbuilder.entity.UserSkill;
import com.cvbuilder.repository.JobPostingRepository;
import com.cvbuilder.service.TranslationService;
import com.fasterxml.jackson.core.type.TypeReference;
import com.fasterxml.jackson.databind.ObjectMapper;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Component;

import java.util.*;
import java.util.stream.Collectors;

@Slf4j
@Component
@RequiredArgsConstructor
public class AiClient {

    private final TranslationService translationService;
    private final JobPostingRepository jobPostingRepository; // mevcut kodun iÃ§inde var, ileride kullanÄ±lÄ±yor olabilir
    private final ObjectMapper objectMapper;

    /**
     * Ä°Å Ä°LANI DETAYLI ANALÄ°ZÄ° - GÃ–RSELDEKÄ° TÃœM EKSÄ°K BÄ°LGÄ°LER Ä°Ã‡Ä°N
     * (Yeni koddan entegre edildi)
     */
    public Map<String, Object> analyzeJobPostingDetailed(String rawJobText) {
        if (rawJobText == null || rawJobText.isBlank()) return createEmptyResponse();

        String prompt = String.format("""
                SEN BÄ°R VERÄ° AYIKLAMA SÄ°STEMÄ°SÄ°N. AÅŸaÄŸÄ±daki iÅŸ ilanÄ± metninden istenen alanlarÄ± kesinlikle ayÄ±kla ve SADECE JSON dÃ¶ndÃ¼r.
                                
                Ã–ZELLÄ°KLE ÅU ÃœÃ‡ BÄ°LGÄ°YÄ° METÄ°N Ä°Ã‡Ä°NDEN BUL:
                1. location: Åehir/Ä°lÃ§e bilgisi.
                2. workType: Hibrit, Uzaktan (Remote), Tam ZamanlÄ± gibi Ã§alÄ±ÅŸma modeli.
                3. experienceLevel: Stajyer, Junior, Senior gibi deneyim beklentisi.

                ANALÄ°Z EDÄ°LECEK METÄ°N:
                %s
                                
                DOLDURULACAK JSON ÅEMASI (Asla aÃ§Ä±klama yapma, sadece JSON):
                {
                  "position": "Ä°ÅŸ baÅŸlÄ±ÄŸÄ±",
                  "company": "Åirket adÄ±",
                  "location": "Konum bilgisi (Ã¶rn: Ä°stanbul, TÃ¼rkiye)",
                  "workType": "Ã‡alÄ±ÅŸma modeli (Ã¶rn: Hibrit veya Remote)",
                  "experienceLevel": "Aranan tecrÃ¼be (Ã¶rn: 0-2 YÄ±l veya Stajyer)",
                  "educationLevel": "EÄŸitim kriteri",
                  "technicalSkills": ["skill1", "skill2"],
                  "responsibilities": ["gÃ¶rev1", "gÃ¶rev2"],
                  "summary": "Ä°ÅŸin 2 cÃ¼mlelik Ã¶zeti"
                }
                """, rawJobText);

        try {
            String response = translationService.generateContent(prompt);
            String cleanJson = extractJsonFromResponse(response);
            return objectMapper.readValue(cleanJson, new TypeReference<Map<String, Object>>() {});
        } catch (Exception e) {
            log.error("AI JSON AyrÄ±ÅŸtÄ±rma HatasÄ±: ", e);
            return createEmptyResponse();
        }
    }

    private String extractJsonFromResponse(String response) {
        if (response == null) return "{}";
        // Regex: ilk '{' ve son '}' karakterleri arasÄ±ndaki bloÄŸu alÄ±r
        String clean = response.replaceAll("(?s)^.*?(\\{.*\\}).*$", "$1").trim();
        return clean.isEmpty() ? "{}" : clean;
    }

    private Map<String, Object> createEmptyResponse() {
        Map<String, Object> map = new HashMap<>();
        String def = "BelirtilmemiÅŸ";
        map.put("position", def);
        map.put("company", "Bilinmiyor");
        map.put("location", def);
        map.put("workType", def);
        map.put("experienceLevel", def);
        map.put("educationLevel", def);
        map.put("technicalSkills", new ArrayList<String>());
        map.put("responsibilities", new ArrayList<String>());
        map.put("summary", "");
        return map;
    }

    /**
     * BÄ°REYSEL Ä°Å ANALÄ°ZÄ°: Aday profili ile iÅŸ ilanÄ±nÄ± ATS kriterlerine gÃ¶re karÅŸÄ±laÅŸtÄ±rÄ±r.
     */
    public String analyzeJobSubmission(UserProfile user, String rawJobText) {
        String userContext = formatUserProfile(user);
        String jobText = safe(rawJobText);

        String prompt = """
              AdayÄ±n profilini iÅŸ ilanÄ±yla semantik (anlamsal) karÅŸÄ±laÅŸtÄ±rma yap. 

### ANALÄ°Z TALÄ°MATLARI:
1. **Derin KarÅŸÄ±laÅŸtÄ±rma:** Sadece anahtar kelime eÅŸleÅŸmesine bakma. AdayÄ±n iÅŸ deneyimlerindeki sorumluluklarÄ±nÄ±, iÅŸ ilanÄ±ndaki "Sorumluluklar" maddeleriyle eÅŸleÅŸtir. 
2. **Kritiklik Seviyesi:** Ä°landaki teknolojileri "Kritik", "Destekleyici" ve "YumuÅŸak Beceriler" olarak sÄ±nÄ±flandÄ±r ve analizi buna gÃ¶re yap.
3. **Dil ve KÃ¼ltÃ¼r:** AdayÄ±n dil seviyesinin (Ã–rn: B2), ilandaki teknik dÃ¶kÃ¼mantasyon okuma veya toplantÄ± yÃ¶netme ihtiyacÄ±nÄ± karÅŸÄ±layÄ±p karÅŸÄ±lamayacaÄŸÄ±nÄ± yorumla.
4. **Ã‡Ä±karÄ±m Yap:** EÄŸer aday "Spring Boot" biliyorsa, onun "Microservices" ve "Java" ekosistemine hakim olduÄŸunu varsayarak yetkinlik skorunu buna gÃ¶re iÅŸle.
5) Ã‡IKARIM YAP (INFERENCE): EÄŸer aday "VeritabanÄ± sÃ¼reÃ§lerini yÃ¶nettim" diyorsa, doÄŸrudan belirtmese bile 'SQL' bildiÄŸini varsay ve bunu "EÅŸleÅŸenler" kÄ±smÄ±nda "TecrÃ¼beden Ã§Ä±karÄ±lmÄ±ÅŸtÄ±r" notuyla belirt.
6) GRUPLAMA YAP: "Microsoft Office", "Excel" ve "Powerpoint" gibi yetenekleri tek tek saymak yerine "Ofis Teknolojileri Uyumlu" ÅŸeklinde stratejik bir baÅŸlÄ±kta birleÅŸtir.
7) SKORLAMA: AdayÄ±n bu iÅŸi yapÄ±p yapamayacaÄŸÄ±na dair 100 Ã¼zerinden bir 'Yeterlilik Skoru' belirle.

---
### Ã‡IKTI FORMATI:

### ğŸ“Š DetaylÄ± Teknik Uyumluluk Analizi
- [Stratejik Yorum]: AdayÄ±n kariyer yolculuÄŸu bu pozisyonun evrimiyle ne kadar Ã¶rtÃ¼ÅŸÃ¼yor? (En az 5 cÃ¼mlelik, teknik derinliÄŸi olan bir paragraf).
- [ATS PuanÄ± Tahmini]: 100 Ã¼zerinden bir uyum skoru ver ve nedenini aÃ§Ä±kla.

### âœ… EÅŸleÅŸen Teknik Yetkinlikler ve Deneyim Transferi
- (AdayÄ±n sahip olduÄŸu bir yeteneÄŸin, ilandaki tam olarak hangi problemi Ã§Ã¶zeceÄŸini aÃ§Ä±kla. Ã–rn: "AdayÄ±n X projesindeki tecrÃ¼besi, ilandaki Y sisteminin kurulmasÄ± iÃ§in kritik Ã¶nemde.")
- (En az 6 detaylÄ± madde)

### âš ï¸ Kritik Yetkinlik BoÅŸluklarÄ± ve Operasyonel Riskler
- (Sadece eksik listesi deÄŸil; bu eksiÄŸin iÅŸe alÄ±m sonrasÄ± oryantasyon sÃ¼resini nasÄ±l etkileyeceÄŸini belirt.)
- (En az 6 detaylÄ± madde)

### ğŸ’¡ MÃ¼lakat Ä°Ã§in Teknik Soru Ã–nerileri
- (AdayÄ±n profilinde belirsiz kalan veya ilanda Ã§ok kritik olan noktalar iÃ§in adaya sorulmasÄ± gereken 3 teknik soru hazÄ±rla.)

### ğŸ¯ Teknik SonuÃ§ ve BaÅŸvuru Durumu
- **DURUM:** [UYGUN / KISMEN UYGUN / RÄ°SKLÄ° / UYGUN DEÄÄ°L]
- **GEREKÃ‡E:** (Verilere dayalÄ±, nihai profesyonel karar Ã¶zeti.)
---

[Aday Profili]
%s

[Ä°ÅŸ Ä°lanÄ±]
%s
                """.formatted(userContext, jobText);

        try {
            String response = translationService.generateContent(prompt);
            if (response != null) {
                // AI kalÄ±ntÄ±larÄ±nÄ± temizle
                response = response.replaceAll("(?i)(ben bir|ben|ai|yapay zeka|asistan|chatbot).*?(\\.|$)", "");
                response = response.replaceAll("(?i)^(merhaba|selam|sayÄ±n|hoÅŸ geldiniz).*?(\\.|$)", "");
                return response.trim();
            }
            return "Analiz servisine ÅŸu anda ulaÅŸÄ±lamÄ±yor.";
        } catch (Exception e) {
            log.error("AI Analiz HatasÄ±: ", e);
            return "Analiz servisine ÅŸu anda ulaÅŸÄ±lamÄ±yor.";
        }
    }

    /**
     * PAZAR ANALÄ°ZÄ°: Belirli bir uzmanlÄ±k alanÄ± iÃ§in toplanan verileri adayÄ±n profiliyle kÄ±yaslar.
     */
    public String performMarketTrendAnalysis(String area, String aggregatedJobData, UserProfile userProfile) {
        String userContext = formatUserProfileForMarketAnalysis(userProfile);

        String prompt = """
            AÅŸaÄŸÄ±daki veriler, veritabanÄ±nda bulunan iÅŸ ilanlarÄ±ndan derlenmiÅŸtir.
            '%s' alanÄ± iÃ§in pazar analizi yap:

            1. '%s' alanÄ±yla ilgili tÃ¼m iÅŸ ilanlarÄ±nÄ± tespit et
            2. Bu ilanlardaki beceri trendlerini analiz et
            3. AdayÄ±n mevcut profiliyle karÅŸÄ±laÅŸtÄ±r
            4. KiÅŸiselleÅŸtirilmiÅŸ geliÅŸim Ã¶nerileri sun

            SADECE METÄ°N ÃœRET, aÃ§Ä±klama yapma, kendini tanÄ±tma.

            Ã–NEMLÄ° KURALLAR:
            - Ä°lanlarÄ± sadece baÅŸlÄ±kla deÄŸil, iÃ§erikte geÃ§en teknoloji ve becerilere gÃ¶re filtrele
            - "Machine Learning" aranÄ±yorsa "Yapay Zeka", "AI", "Veri Bilimi" gibi ilgili terimleri de dikkate al
            - Ä°statistiksel analiz yap: "100 ilanÄ±n 85'inde Python gerekiyor (%85)"
            - Somut ve Ã¶lÃ§Ã¼lebilir Ã¶neriler sun

            Ã‡IKTI FORMATI (TÃœRKÃ‡E):

            ### ğŸ“Š GENEL PAZAR DURUMU
            - Toplam analiz edilen ilan sayÄ±sÄ±: [sayÄ±]
            - '%s' ile ilgili bulunan ilan sayÄ±sÄ±: [sayÄ±]
            - Pazar bÃ¼yÃ¼klÃ¼ÄŸÃ¼ ve talep eÄŸilimleri

            ### ğŸ”¥ EN Ã‡OK TALEP EDÄ°LEN 10 BECERÄ°
            1. [Beceri 1] - [%X] oranÄ±nda talep ediliyor
            2. [Beceri 2] - [%Y] oranÄ±nda talep ediliyor
            ...

            ### âœ… PROFÄ°LÄ°NÄ°ZLE EÅLEÅEN BECERÄ°LER
            - [Beceri 1]: Bu beceriye sahipsiniz - pazar deÄŸerinizi artÄ±rÄ±yor âœ“
            - [Beceri 2]: ...

            ### âš ï¸ KRÄ°TÄ°K EKSÄ°K BECERÄ°LERÄ°NÄ°Z
            - [Beceri 1]: %[X] talep oranÄ± - Ã–NCELÄ°KLÄ° Ã–ÄRENMENÄ°Z GEREKÄ°YOR
            - [Beceri 2]: %[Y] talep oranÄ± - Ã–NEMLÄ° BÄ°R EKSÄ°K
            ...

            ### ğŸ¯ SÄ°ZE Ã–ZEL GELÄ°ÅÄ°M YOL HARÄ°TASI
            - Ä°LK 3 AY: [En kritik 3 beceri]
            - 3-6 AY: [Orta vadeli hedefler]
            - 6-12 AY: [Uzun vadeli uzmanlaÅŸma]

            ### ğŸ’ SÄ°ZÄ° Ã–NE Ã‡IKARACAK "KILLER SKILLS"
            - [Niche beceri 1]: Neden Ã¶nemli?
            - [Niche beceri 2]: Rakiplerden farkÄ±nÄ±z

            ### ğŸ“š Ã–NERÄ°LEN Ã–ÄRENME KAYNAKLARI
            - [Beceri 1 iÃ§in]: [Kurs/Kaynak Ã¶nerisi]
            - [Beceri 2 iÃ§in]: [Kurs/Kaynak Ã¶nerisi]

            [TÃœM Ä°LAN VERÄ°LERÄ°]
            %s

            [ADAY PROFÄ°LÄ°]
            %s
            """.formatted(area, area, aggregatedJobData, userContext);

        try {
            String response = translationService.generateContent(prompt);
            if (response != null) {
                // AI kalÄ±ntÄ±larÄ±nÄ± temizle
                response = response.replaceAll("(?i)(ben bir|ben|ai|yapay zeka|asistan|chatbot).*?(\\.|$)", "");
                response = response.replaceAll("(?i)^(merhaba|selam|sayÄ±n|hoÅŸ geldiniz).*?(\\.|$)", "");
                return response.trim();
            }
            return "Pazar analizi ÅŸu an gerÃ§ekleÅŸtirilemiyor.";
        } catch (Exception e) {
            log.error("Pazar Analizi HatasÄ±: ", e);
            return "Pazar analizi ÅŸu an gerÃ§ekleÅŸtirilemiyor.";
        }
    }

    public String formatAllJobPostingsForAI(List<JobPosting> allJobs) {
        StringBuilder sb = new StringBuilder();
        int totalJobs = allJobs == null ? 0 : allJobs.size();
        sb.append("TOPLAM Ä°LAN SAYISI: ").append(totalJobs).append("\n\n");

        if (allJobs == null || allJobs.isEmpty()) {
            return sb.append("Bu alanda henÃ¼z ilan bulunmuyor.").toString();
        }

        // TÃ¼m ilanlarÄ± formatla (gerÃ§ek sayÄ±yÄ± gÃ¶ster, limit yok)
        for (int i = 0; i < allJobs.size(); i++) {
            JobPosting job = allJobs.get(i);
            sb.append("--- Ä°LAN ").append(i + 1).append(" / ").append(totalJobs).append(" ---\n");
            sb.append("POZÄ°SYON: ").append(safe(job.getPosition())).append("\n");
            sb.append("GEREKLÄ° BECERÄ°LER: ").append(safe(job.getRequiredSkills())).append("\n");
            String cleaned = safe(job.getCleanedText());
            if (!cleaned.isEmpty()) {
                sb.append("AÃ‡IKLAMA: ")
                  .append(cleaned.substring(0, Math.min(500, cleaned.length())));
                if (cleaned.length() > 500) sb.append("...");
                sb.append("\n\n");
            }
        }

        return sb.toString();
    }

    private String formatUserProfileForMarketAnalysis(UserProfile user) {
        if (user == null) return "Profil bilgisi bulunamadÄ±.";

        StringBuilder sb = new StringBuilder();
        sb.append("=== TEMEL BÄ°LGÄ°LER ===\n");
        sb.append("BaÅŸlÄ±k/UzmanlÄ±k: ").append(safe(user.getTitle())).append("\n");
        if (user.getTotalExperienceYear() != null) {
            sb.append("Toplam Deneyim: ").append(user.getTotalExperienceYear()).append(" yÄ±l\n");
        }

        sb.append("\n=== TEKNÄ°K BECERÄ°LER ===\n");
        if (user.getSkills() != null && !user.getSkills().isEmpty()) {
            user.getSkills().forEach(skill -> sb.append("- ").append(safe(skill.getSkillName())).append("\n"));
        } else {
            sb.append("BelirtilmemiÅŸ\n");
        }

        sb.append("\n=== DÄ°L BÄ°LGÄ°SÄ° ===\n");
        if (user.getLanguages() != null && !user.getLanguages().isEmpty()) {
            user.getLanguages().forEach(lang -> sb.append("- ").append(safe(lang.getLanguage()))
                    .append(" (").append(safe(lang.getLevel())).append(")\n"));
        } else {
            sb.append("BelirtilmemiÅŸ\n");
        }

        sb.append("\n=== EÄÄ°TÄ°M ===\n");
        if (user.getEducations() != null && !user.getEducations().isEmpty()) {
            user.getEducations().forEach(edu -> sb.append("- ").append(safe(edu.getDepartment()))
                    .append(", ").append(safe(edu.getSchoolName()))
                    .append(" (").append(safe(edu.getDegree())).append(")\n"));
        } else {
            sb.append("BelirtilmemiÅŸ\n");
        }

        return sb.toString();
    }

    /**
     * Universal JSON analiz (JobAnalysisServiceImpl'in kullandÄ±ÄŸÄ± metot)
     */
    public String analyzeJobPostingUniversal(String rawJobText) {
        if (rawJobText == null) rawJobText = "";

        String prompt = String.format(
                "AÅŸaÄŸÄ±daki iÅŸ ilanÄ±nÄ± analiz et ve SADECE JSON DÃ–NDÃœR.\n" +
                "JSON DIÅINDA HÄ°Ã‡BÄ°R ÅEY YAZMA. Markdown yok. Kod bloÄŸu yok. AÃ§Ä±klama yapma.\n\n" +
                "JSON SCHEMA:\n" +
                "{\n" +
                "  \"position\": \"...\",\n" +
                "  \"company\": \"...\",\n" +
                "  \"location\": \"...\",\n" +
                "  \"workType\": \"...\",\n" +
                "  \"experienceLevel\": \"...\",\n" +
                "  \"educationLevel\": \"...\",\n" +
                "  \"militaryStatus\": \"...\",\n" +
                "  \"languages\": [\"...\"],\n" +
                "  \"salary\": \"...\",\n" +
                "  \"summary\": \"...\",\n" +
                "  \"technicalSkills\": [\"...\"],\n" +
                "  \"responsibilities\": [\"...\"]\n" +
                "}\n\n" +
                "IS ILANI METNI:\n%s\n",
                rawJobText
        );

        try {
            String response = translationService.generateContent(prompt);
            if (response == null) return "{}";
            return response.replaceAll("```json|```", "").trim();
        } catch (Exception e) {
            log.error("AI JSON Analiz HatasÄ±: ", e);
            return "{}";
        }
    }

    public List<String> generateTailoredSummaries(UserProfile profile, String jobContext) {
        String rawTitle = profile != null ? safe(profile.getTitle()) : "Profesyonel";
        String userTitle = toTitleCase(rawTitle);
        String skills = getPrioritizedSkills(profile);
        int years = (profile != null && profile.getTotalExperienceYear() != null) ? profile.getTotalExperienceYear() : 0;

        List<String> summaries = new ArrayList<>();
        summaries.add(String.format("%s deneyime sahip bir %s olarak, %s alanlarÄ±ndaki yetkinliÄŸimle deÄŸer katmayÄ± hedefliyorum.",
                years > 0 ? years + " yÄ±l" : "Yeni mezun", userTitle, skills));

        try {
            String aiSummary = translationService.generateContent(String.format(
                    "AÅŸaÄŸÄ±daki bilgilere gÃ¶re profesyonel bir CV Ã¶zet cÃ¼mlesi yaz (maksimum 2 cÃ¼mle). " +
                    "SADECE METÄ°N YAZ, aÃ§Ä±klama yapma, kendini tanÄ±tma, \"ben bir AI'Ä±m\" gibi ifadeler kullanma.\n\n" +
                    "Unvan: %s\nDeneyim: %d yÄ±l\nYetenekler: %s",
                    userTitle, years, skills
            ));
            if (aiSummary != null && !aiSummary.isBlank()) {
                String cleaned = aiSummary.replace("\"", "").trim();
                // AI kalÄ±ntÄ±larÄ±nÄ± temizle
                cleaned = cleaned.replaceAll("(?i)(ben bir|ben|ai|yapay zeka|asistan|chatbot).*?(\\.|$)", "");
                summaries.add(cleaned);
            }
        } catch (Exception e) {
            log.warn("AI Ã–zet oluÅŸturulamadÄ±.");
        }

        return summaries;
    }

    public List<OptimizedCvItem> optimizeExperiences(UserProfile profile, JobPosting job) {
        if (profile == null || profile.getExperiences() == null) return Collections.emptyList();
        String jobSkills = (job != null) ? safe(job.getRequiredSkills()) : "";

        return profile.getExperiences().stream().map(exp -> {
            String desc = safe(exp.getDescription());
            if (desc.length() > 10) desc = fixGrammarStrict(desc);

            String matched = findIntersection(desc, jobSkills);
            if (!matched.isEmpty()) desc += " Bu gÃ¶revde " + matched + " yetkinliklerini aktif olarak kullandÄ±m.";

            return new OptimizedCvItem(
                    safe(exp.getPosition()),
                    safe(exp.getCompany()),
                    formatDateRange(exp.getStartDate(), exp.getEndDate()),
                    Collections.singletonList(desc)
            );
        }).collect(Collectors.toList());
    }

    public List<OptimizedCvItem> optimizeProjects(UserProfile profile, JobPosting job) {
        if (profile == null || profile.getProjects() == null) return Collections.emptyList();
        return profile.getProjects().stream().map(p -> new OptimizedCvItem(
                safe(p.getProjectName()), "Proje",
                formatDateRange(p.getStartDate(), (p.getIsOngoing() != null && p.getIsOngoing()) ? null : p.getEndDate()),
                Collections.singletonList(fixGrammarStrict(safe(p.getDescription())))
        )).collect(Collectors.toList());
    }

    public List<UserEducationDTO> optimizeEducation(UserProfile profile, JobPosting job) {
        if (profile == null || profile.getEducations() == null) return Collections.emptyList();
        return profile.getEducations().stream().map(e -> UserEducationDTO.builder()
                .id(e.getId())
                .schoolName(fixGrammarStrict(safe(e.getSchoolName())))
                .department(fixGrammarStrict(safe(e.getDepartment())))
                .degree(safe(e.getDegree()))
                .startYear(safe(e.getStartYear()))
                .graduationYear(e.getEndYear())
                .gpa(safe(e.getGpa()))
                .build()).collect(Collectors.toList());
    }

    public List<UserLanguageDTO> optimizeLanguages(UserProfile profile, JobPosting job) {
        if (profile == null || profile.getLanguages() == null) return Collections.emptyList();
        return profile.getLanguages().stream().map(l -> UserLanguageDTO.builder()
                .id(l.getId())
                .language(safe(l.getLanguage()))
                .level(safe(l.getLevel()))
                .build()).collect(Collectors.toList());
    }

    public List<UserCertificateDTO> optimizeCertificates(UserProfile profile, JobPosting job) {
        if (profile == null || profile.getCertificates() == null) return Collections.emptyList();
        return profile.getCertificates().stream().map(c -> UserCertificateDTO.builder()
                .id(c.getId())
                .name(safe(c.getName()))
                .issuer(safe(c.getIssuer()))
                .date(safe(c.getDate()))
                .url(safe(c.getUrl()))
                .build()).collect(Collectors.toList());
    }

    public String getCareerAdvice(String jobTitle) {
        if (jobTitle == null || jobTitle.isBlank()) return "Tavsiye oluÅŸturulamadÄ±.";
        String prompt = "'" + jobTitle + "' pozisyonu iÃ§in kariyer trendleri ve geliÅŸim Ã¶nerilerini TÃ¼rkÃ§e maddeler halinde yaz. " +
                "SADECE METÄ°N YAZ, aÃ§Ä±klama yapma, kendini tanÄ±tma, \"ben\" veya \"siz\" gibi ifadeler kullanma. " +
                "Direkt olarak maddeleri yaz, giriÅŸ yapma.";
        try {
            String response = translationService.generateContent(prompt);
            if (response != null) {
                // AI kalÄ±ntÄ±larÄ±nÄ± temizle
                response = response.replaceAll("(?i)(ben bir|ben|ai|yapay zeka|asistan|chatbot).*?(\\.|$)", "");
                response = response.replaceAll("(?i)^(merhaba|selam|sayÄ±n).*?(\\.|$)", "");
                return response.trim();
            }
            return "Kariyer tavsiyesi ÅŸu an oluÅŸturulamÄ±yor.";
        } catch (Exception e) {
            log.error("Kariyer Tavsiyesi HatasÄ±: ", e);
            return "Kariyer tavsiyesi ÅŸu an oluÅŸturulamÄ±yor.";
        }
    }

    public String analyzeMarketWithAI(String area, List<JobPosting> allJobs, UserProfile userProfile) {
        String allJobsFormatted = formatAllJobPostingsForAI(allJobs);
        String userContext = formatUserProfileForMarketAnalysis(userProfile);
        int jobCount = allJobs != null ? allJobs.size() : 0;

        String prompt = """
            AÅŸaÄŸÄ±da sistem veritabanÄ±nda kayÄ±tlÄ± %d adet iÅŸ ilanÄ± ve bir adayÄ±n profili var.
            '%s' alanÄ± iÃ§in pazar analizi yap.

            VERÄ° KAYNAÄI:
            - Sistem veritabanÄ±nda kayÄ±tlÄ± %d iÅŸ ilanÄ± analizi
            - HÄ°Ã‡BÄ°R ZAMAN "Son X ilan" gibi ifadeler kullanma, sadece gerÃ§ek sayÄ±yÄ± belirt

            SADECE METÄ°N ÃœRET, aÃ§Ä±klama yapma, kendini tanÄ±tma.

            Ã‡IKTI FORMATI (TÃœRKÄ°YE, Markdown, KISA VE SADE - ADIM ADIM):

            ## ğŸ“Š %s SektÃ¶r Analizi

            **Kaynak:** Sistem veritabanÄ±nda kayÄ±tlÄ± %d iÅŸ ilanÄ± analizi

            ---

            ### 1ï¸âƒ£ SEKTÃ–R ANALÄ°ZÄ° - En Ã‡ok Aranan Yetkinlikler

            1. **Beceri AdÄ±**
               - KÄ±sa aÃ§Ä±klama (maksimum 1 cÃ¼mle)

            2. **Beceri AdÄ±**
               - KÄ±sa aÃ§Ä±klama (maksimum 1 cÃ¼mle)

            [Toplam 15 beceri, her biri aynÄ± formatta]

            ---

            ### 2ï¸âƒ£ PROFÄ°LÄ°NÄ°ZE Ã–ZEL TAVSÄ°YELER

            **GÃ¼Ã§lÃ¼ YÃ¶nleriniz:**
            - Beceri adÄ±: KÄ±sa neden gÃ¼Ã§lÃ¼ (maksimum 1 cÃ¼mle)
            - Beceri adÄ±: KÄ±sa neden gÃ¼Ã§lÃ¼ (maksimum 1 cÃ¼mle)

            **GeliÅŸtirmeniz Gerekenler:**
            - Beceri adÄ±: KÄ±sa neden geliÅŸtirmeli (maksimum 1 cÃ¼mle)
            - Beceri adÄ±: KÄ±sa nasÄ±l geliÅŸtirirsiniz (maksimum 1 cÃ¼mle)

            **Ã–ncelikli Aksiyonlar (3 Ay):**
            1. KÄ±sa aksiyon (maksimum 1 cÃ¼mle)
            2. KÄ±sa aksiyon (maksimum 1 cÃ¼mle)
            3. KÄ±sa aksiyon (maksimum 1 cÃ¼mle)

            ---

            ### 3ï¸âƒ£ KRÄ°TÄ°K EKSÄ°KLÄ°KLER

            1. **Beceri AdÄ±**
               - Neden kritik (maksimum 1 cÃ¼mle)

            2. **Beceri AdÄ±**
               - Neden kritik (maksimum 1 cÃ¼mle)

            [Toplam 5 eksiklik, her biri aynÄ± formatta]

            ---

            [Ä°LAN VERÄ°LERÄ°]
            %s

            [ADAY PROFÄ°LÄ°]
            %s

            Ã‡OK Ã–NEMLÄ° KURALLAR:
            - Her madde MUTLAKA kÄ±sa olsun (maksimum 1 cÃ¼mle)
            - Uzun paragraflar YAZMA, sadece kÄ±sa maddeler
            - "Son X ilan" gibi ifadeler ASLA kullanma
            - SADECE METÄ°N ÃœRET, aÃ§Ä±klama yapma, kendini tanÄ±tma
            - "Ben", "Siz", "AI", "yapay zeka" gibi ifadeler ASLA kullanma
            - Direkt olarak analizi yaz, giriÅŸ cÃ¼mlesi yazma
            """.formatted(jobCount, jobCount, area, area, jobCount, allJobsFormatted, userContext);

        try {
            String response = translationService.generateContent(prompt);
            if (response != null) {
                // AI kalÄ±ntÄ±larÄ±nÄ± temizle
                response = response.replaceAll("(?i)(ben bir|ben|ai|yapay zeka|asistan|chatbot).*?(\\.|$)", "");
                response = response.replaceAll("(?i)^(merhaba|selam|sayÄ±n|hoÅŸ geldiniz).*?(\\.|$)", "");
                return response.trim();
            }
            return "Pazar analizi ÅŸu an gerÃ§ekleÅŸtirilemiyor. LÃ¼tfen daha sonra tekrar deneyin.";
        } catch (Exception e) {
            log.error("AI Pazar Analizi HatasÄ±: ", e);
            return "Pazar analizi ÅŸu an gerÃ§ekleÅŸtirilemiyor. LÃ¼tfen daha sonra tekrar deneyin.";
        }
    }

    public String getQuickMarketAnalysis(String area, List<JobPosting> relevantJobs, UserProfile userProfile) {
        String userContext = formatUserProfileForMarketAnalysis(userProfile);
        String jobsSummary = formatJobsSummaryForQuickAnalysis(relevantJobs);

        String prompt = """
            '%s' alanÄ±ndaki iÅŸ ilanlarÄ±nÄ± ve adayÄ±n profilini analiz et.
            SADECE METÄ°N ÃœRET, aÃ§Ä±klama yapma, kendini tanÄ±tma.

            [Ä°LAN Ã–ZETÄ°]
            %s

            [ADAY PROFÄ°LÄ°]
            %s
            """.formatted(area, jobsSummary, userContext);

        try {
            String response = translationService.generateContent(prompt);
            if (response != null) {
                // AI kalÄ±ntÄ±larÄ±nÄ± temizle
                response = response.replaceAll("(?i)(ben bir|ben|ai|yapay zeka|asistan|chatbot).*?(\\.|$)", "");
                response = response.replaceAll("(?i)^(merhaba|selam|sayÄ±n|hoÅŸ geldiniz).*?(\\.|$)", "");
                return response.trim();
            }
            return "HÄ±zlÄ± analiz ÅŸu an yapÄ±lamÄ±yor.";
        } catch (Exception e) {
            log.error("HÄ±zlÄ± Pazar Analizi HatasÄ±: ", e);
            return "HÄ±zlÄ± analiz ÅŸu an yapÄ±lamÄ±yor.";
        }
    }

    private String formatJobsSummaryForQuickAnalysis(List<JobPosting> jobs) {
        if (jobs == null || jobs.isEmpty()) return "Bu alanda ilan bulunamadÄ±.";

        StringBuilder sb = new StringBuilder();
        sb.append("Toplam Ä°lan: ").append(jobs.size()).append("\n\n");

        Map<String, Integer> skillFrequency = new HashMap<>();
        for (JobPosting job : jobs) {
            if (job.getRequiredSkills() != null) {
                String[] skills = job.getRequiredSkills().split("[,;]");
                for (String skill : skills) {
                    String trimmed = skill.trim();
                    if (!trimmed.isEmpty()) {
                        skillFrequency.put(trimmed, skillFrequency.getOrDefault(trimmed, 0) + 1);
                    }
                }
            }
        }

        sb.append("En Ã‡ok GeÃ§en Beceriler:\n");
        skillFrequency.entrySet().stream()
                .sorted((a, b) -> b.getValue().compareTo(a.getValue()))
                .limit(10)
                .forEach(entry -> {
                    double percentage = (entry.getValue() * 100.0) / jobs.size();
                    sb.append("- ").append(entry.getKey())
                      .append(": %").append(String.format("%.1f", percentage))
                      .append(" (").append(entry.getValue()).append(" ilan)\n");
                });

        return sb.toString();
    }

    /**
     * GENEL PAZAR ANALÄ°ZÄ°: VeritabanÄ± olmadan, AI'Ä±n genel bilgisiyle meslek iÃ§in pazar analizi yapar.
     * Bu metod, TÃ¼rkiye pazarÄ±ndaki tipik iÅŸ ilanlarÄ±nÄ± ve beceri gereksinimlerini analiz eder.
     */
    public String generateGeneralMarketAnalysis(String area, UserProfile userProfile) {
        String userContext = formatUserProfileForMarketAnalysis(userProfile);

        String prompt = """
            '%s' alanÄ± iÃ§in TÃ¼rkiye iÅŸ pazarÄ± analizi yap.
            
            100+ farklÄ± meslek dalÄ± hakkÄ±nda bilgi kullanÄ±labilir: MÃ¼hendislik, SaÄŸlÄ±k, EÄŸitim, Finans, Pazarlama, 
            Ä°nsan KaynaklarÄ±, Hukuk, MimarlÄ±k, TasarÄ±m, Ä°ÅŸletme, Lojistik, SatÄ±ÅŸ, ve daha fazlasÄ±.

            VERÄ° KAYNAÄI: Genel pazar trendleri ve meslek standartlarÄ±na dayalÄ± deÄŸerlendirme.
            HÄ°Ã‡BÄ°R ZAMAN "Son X ilan analiz edildi" gibi iddialÄ± ifadeler kullanma.

            SADECE METÄ°N ÃœRET, aÃ§Ä±klama yapma, kendini tanÄ±tma.

            Ã‡IKTI FORMATI (TÃœRKÄ°YE, Markdown, KISA VE SADE - ADIM ADIM):

            ## ğŸ“Š %s SektÃ¶r Analizi

            **Kaynak:** AI tabanlÄ± genel pazar deÄŸerlendirmesi

            ---

            ### 1ï¸âƒ£ SEKTÃ–R ANALÄ°ZÄ° - En Ã‡ok Aranan Yetkinlikler

            1. **Beceri AdÄ±**
               - KÄ±sa aÃ§Ä±klama (maksimum 1 cÃ¼mle)

            2. **Beceri AdÄ±**
               - KÄ±sa aÃ§Ä±klama (maksimum 1 cÃ¼mle)

            [Toplam 15 beceri, her biri aynÄ± formatta]

            ---

            ### 2ï¸âƒ£ PROFÄ°LÄ°NÄ°ZE Ã–ZEL TAVSÄ°YELER

            **GÃ¼Ã§lÃ¼ YÃ¶nleriniz:**
            - Beceri adÄ±: KÄ±sa neden gÃ¼Ã§lÃ¼ (maksimum 1 cÃ¼mle)
            - Beceri adÄ±: KÄ±sa neden gÃ¼Ã§lÃ¼ (maksimum 1 cÃ¼mle)

            **GeliÅŸtirmeniz Gerekenler:**
            - Beceri adÄ±: KÄ±sa neden geliÅŸtirmeli (maksimum 1 cÃ¼mle)
            - Beceri adÄ±: KÄ±sa nasÄ±l geliÅŸtirirsiniz (maksimum 1 cÃ¼mle)

            **Ã–ncelikli Aksiyonlar (3 Ay):**
            1. KÄ±sa aksiyon (maksimum 1 cÃ¼mle)
            2. KÄ±sa aksiyon (maksimum 1 cÃ¼mle)
            3. KÄ±sa aksiyon (maksimum 1 cÃ¼mle)

            ---

            ### 3ï¸âƒ£ KRÄ°TÄ°K EKSÄ°KLÄ°KLER

            1. **Beceri AdÄ±**
               - Neden kritik (maksimum 1 cÃ¼mle)

            2. **Beceri AdÄ±**
               - Neden kritik (maksimum 1 cÃ¼mle)

            [Toplam 5 eksiklik, her biri aynÄ± formatta]

            ---

            [ADAY PROFÄ°LÄ°]
            %s

            Ã‡OK Ã–NEMLÄ° KURALLAR:
            - Her madde MUTLAKA kÄ±sa olsun (maksimum 1 cÃ¼mle)
            - Uzun paragraflar YAZMA, sadece kÄ±sa maddeler
            - "Son X ilan" gibi ifadeler ASLA kullanma
            - MesleÄŸe Ã¶zel teknik becerileri listele
            - DoÄŸal, insan gibi yaz, robot gibi gÃ¶rÃ¼nme
            - SADECE METÄ°N ÃœRET, aÃ§Ä±klama yapma, kendini tanÄ±tma
            - "Ben", "Siz", "AI", "yapay zeka" gibi ifadeler ASLA kullanma
            - Direkt olarak analizi yaz, giriÅŸ cÃ¼mlesi yazma
            """.formatted(area, area, userContext);

        try {
            String response = translationService.generateContent(prompt);
            if (response != null) {
                // AI kalÄ±ntÄ±larÄ±nÄ± temizle
                response = response.replaceAll("(?i)(ben bir|ben|ai|yapay zeka|asistan|chatbot).*?(\\.|$)", "");
                response = response.replaceAll("(?i)^(merhaba|selam|sayÄ±n|hoÅŸ geldiniz).*?(\\.|$)", "");
                return response.trim();
            }
            return "Genel pazar analizi ÅŸu an gerÃ§ekleÅŸtirilemiyor. LÃ¼tfen daha sonra tekrar deneyin.";
        } catch (Exception e) {
            log.error("Genel Pazar Analizi HatasÄ±: ", e);
            return "Genel pazar analizi ÅŸu an gerÃ§ekleÅŸtirilemiyor. LÃ¼tfen daha sonra tekrar deneyin.";
        }
    }

    /**
     * GENEL PAZAR BECERÄ°LERÄ°: Meslek iÃ§in tipik olarak aranan becerileri JSON formatÄ±nda dÃ¶ndÃ¼rÃ¼r.
     * Bu metod, veritabanÄ± olmadan AI'Ä±n genel bilgisiyle beceri listesi Ã¼retir.
     * 100+ farklÄ± meslek dalÄ± iÃ§in kapsamlÄ± analiz yapabilir.
     */
    public String generateGeneralMarketSkills(String area) {
        String prompt = String.format(
                "'%s' alanÄ± iÃ§in TÃ¼rkiye'de tipik olarak aranan becerileri analiz et.\n" +
                "100+ farklÄ± meslek dalÄ± hakkÄ±nda bilgi kullanÄ±labilir: MÃ¼hendislik, SaÄŸlÄ±k, EÄŸitim, Finans, Pazarlama, Ä°nsan KaynaklarÄ±, Hukuk, MimarlÄ±k, TasarÄ±m, Ä°ÅŸletme, Lojistik, SatÄ±ÅŸ, Turizm, ve daha fazlasÄ±.\n\n" +
                "Meslek adÄ±nÄ± TAM olarak anla - Ã¶rneÄŸin 'Makine MÃ¼hendisliÄŸi' dediysen, sadece genel mÃ¼hendislik deÄŸil, makine mÃ¼hendisliÄŸine Ã¶zel becerileri de listele.\n" +
                "SADECE JSON DÃ–NDÃœR, aÃ§Ä±klama yapma, kendini tanÄ±tma.\n\n" +
                "JSON FORMATI:\n" +
                "{\n" +
                "  \"skills\": [\n" +
                "    {\"name\": \"Beceri AdÄ±\", \"frequency\": 85, \"importance\": \"YÃ¼ksek/Orta/DÃ¼ÅŸÃ¼k\"},\n" +
                "    {\"name\": \"Beceri AdÄ±\", \"frequency\": 75, \"importance\": \"YÃ¼ksek\"}\n" +
                "  ]\n" +
                "}\n\n" +
                "KURALLAR:\n" +
                "- En az 15, en fazla 25 beceri listele\n" +
                "- Frequency: Bu becerinin iÅŸ ilanlarÄ±nda geÃ§me yÃ¼zdesi (0-100 arasÄ±)\n" +
                "  - YÃ¼ksek talep: 70-100 (Ã¶rn: Makine MÃ¼hendisliÄŸi iÃ§in SolidWorks: 85)\n" +
                "  - Orta talep: 40-69\n" +
                "  - DÃ¼ÅŸÃ¼k talep: 10-39\n" +
                "- Importance: Becerinin kritikliÄŸi (YÃ¼ksek/Orta/DÃ¼ÅŸÃ¼k)\n" +
                "- Becerileri Ã¶nem sÄ±rasÄ±na gÃ¶re sÄ±rala (frequency yÃ¼ksekten dÃ¼ÅŸÃ¼ÄŸe)\n" +
                "- Sadece gerÃ§ekÃ§i, TÃ¼rkiye pazarÄ±nda aranan beceriler ekle\n" +
                "- MesleÄŸe Ã¶zel teknik becerileri MUTLAKA dahil et (Ã¶rn: Makine MÃ¼hendisliÄŸi: SolidWorks, AutoCAD, ANSYS, Catia, Siemens NX, GD&T, CNC)\n" +
                "- Genel becerileri de ekle (Ä°ngilizce, Proje YÃ¶netimi, Excel, vs.)\n" +
                "- HiÃ§bir mesleÄŸi kaÃ§Ä±rma - meslek adÄ±nÄ± doÄŸru tanÄ± ve o mesleÄŸe Ã¶zel becerileri listele\n\n" +
                "MESLEK/ALAN: %s",
                area, area
        );

        try {
            String response = translationService.generateContent(prompt);
            if (response == null) return "{\"skills\":[]}";
            // JSON bloÄŸunu temizle
            String cleanJson = response.replaceAll("```json|```", "").trim();
            // Ä°lk { ve son } arasÄ±ndaki iÃ§eriÄŸi al
            int firstBrace = cleanJson.indexOf('{');
            int lastBrace = cleanJson.lastIndexOf('}');
            if (firstBrace >= 0 && lastBrace > firstBrace) {
                return cleanJson.substring(firstBrace, lastBrace + 1);
            }
            return cleanJson;
        } catch (Exception e) {
            log.error("Genel Pazar Becerileri HatasÄ±: ", e);
            return "{\"skills\":[]}";
        }
    }

    private String formatUserProfile(UserProfile user) {
        if (user == null) return "Profil bilgisi bulunamadÄ±.";

        StringBuilder sb = new StringBuilder();
        sb.append("=== TEMEL BÄ°LGÄ°LER ===\n");
        sb.append("BaÅŸlÄ±k: ").append(safe(user.getTitle())).append("\n");
        if (user.getTotalExperienceYear() != null) sb.append("Toplam Deneyim: ").append(user.getTotalExperienceYear()).append(" yÄ±l\n");

        sb.append("\n=== ANALÄ°Z Ä°Ã‡Ä°N KRÄ°TÄ°K YETKÄ°NLÄ°KLER (TEKNÄ°K + DÄ°L) ===\n");
        List<String> combinedCapabilities = new ArrayList<>();

        if (user.getLanguages() != null && !user.getLanguages().isEmpty()) {
            user.getLanguages().stream()
                    .map(l -> "DÄ°L: " + safe(l.getLanguage()) + " (Seviye: " + safe(l.getLevel()) + ")")
                    .forEach(combinedCapabilities::add);
        }

        if (user.getSkills() != null) {
            user.getSkills().stream().map(UserSkill::getSkillName).forEach(combinedCapabilities::add);
        }
        sb.append(String.join(", ", combinedCapabilities)).append("\n");

        if (user.getExperiences() != null && !user.getExperiences().isEmpty()) {
            sb.append("\n=== DENEYÄ°M Ã–ZETÄ° ===\n");
            user.getExperiences().stream().limit(5).forEach(exp -> sb.append("- ").append(safe(exp.getPosition()))
                    .append(" @ ").append(safe(exp.getCompany()))
                    .append(" (").append(formatDateRange(exp.getStartDate(), exp.getEndDate())).append(")\n"));
        }

        if (user.getEducations() != null && !user.getEducations().isEmpty()) {
            sb.append("\n=== EÄÄ°TÄ°M ===\n");
            user.getEducations().forEach(edu -> sb.append("- ").append(safe(edu.getDepartment()))
                    .append(", ").append(safe(edu.getSchoolName()))
                    .append(" (").append(safe(edu.getDegree())).append(")\n"));
        }

        sb.append("\n=== EK BÄ°LGÄ°LER ===\n");
        String ms = safe(user.getMilitaryStatus());
        if (!ms.isBlank()) sb.append("Askerlik Durumu: ").append(ms).append("\n");

        return sb.toString();
    }

    private String getPrioritizedSkills(UserProfile profile) {
        if (profile == null || profile.getSkills() == null || profile.getSkills().isEmpty()) return "Mesleki Yetkinlikler";
        return profile.getSkills().stream().limit(5).map(UserSkill::getSkillName).collect(Collectors.joining(", "));
    }

    private String fixGrammarStrict(String text) {
        if (text == null || text.length() < 10) return text;
        try {
            String res = translationService.generateContent(
                    "AÅŸaÄŸÄ±daki metni anlamÄ±nÄ± bozmadan profesyonel bir dille ve imla kurallarÄ±na uygun olarak dÃ¼zelt. " +
                    "SADECE DÃœZELTÄ°LMÄ°Å METNÄ° YAZ, aÃ§Ä±klama yapma, kendini tanÄ±tma.\n\n" + text
            );
            if (res != null) {
                String cleaned = res.trim();
                // AI kalÄ±ntÄ±larÄ±nÄ± temizle
                cleaned = cleaned.replaceAll("(?i)^(dÃ¼zeltilmiÅŸ|dÃ¼zenlenmiÅŸ|iÅŸte|ÅŸÃ¶yle).*?:\\s*", "");
                cleaned = cleaned.replaceAll("(?i)(ben bir|ben|ai|yapay zeka|asistan).*?(\\.|$)", "");
                return cleaned;
            }
            return text;
        } catch (Exception e) {
            return text;
        }
    }

    private String findIntersection(String text, String skills) {
        if (text == null || skills == null || skills.isBlank()) return "";
        Set<String> match = new HashSet<>();
        String tLower = text.toLowerCase(new Locale("tr", "TR"));
        for (String s : skills.split("[,;]")) {
            String sTrim = s.trim().toLowerCase(new Locale("tr", "TR"));
            if (!sTrim.isEmpty() && tLower.contains(sTrim)) match.add(s.trim());
        }
        return String.join(", ", match);
    }

    private String toTitleCase(String input) {
        if (input == null || input.isEmpty()) return "";
        return Arrays.stream(input.trim().split("\\s+"))
                .map(w -> w.isEmpty() ? "" : Character.toUpperCase(w.charAt(0)) + w.substring(1).toLowerCase(new Locale("tr", "TR")))
                .collect(Collectors.joining(" "));
    }

    private String safe(String text) {
        return (text == null || text.equalsIgnoreCase("null")) ? "" : text.trim();
    }

    private String formatDateRange(String start, String end) {
        String s = (start != null && !start.isBlank()) ? start : "BelirtilmemiÅŸ";
        String e = (end != null && !end.isBlank()) ? end : "Devam Ediyor";
        return s + " - " + e;
    }
}
