package com.cvbuilder.external;

import com.cvbuilder.dto.*;
import com.cvbuilder.entity.*;
import com.cvbuilder.repository.JobPostingRepository;
import com.cvbuilder.service.TranslationService;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import java.util.*;
import java.util.stream.Collectors;

@Component
public class AiClient {

    private static final Logger log = LoggerFactory.getLogger(AiClient.class);
    private final TranslationService translationService;
    private final JobPostingRepository jobPostingRepository;

    @Autowired
    public AiClient(TranslationService translationService, JobPostingRepository jobPostingRepository) {
        this.translationService = translationService;
        this.jobPostingRepository = jobPostingRepository;
    }

    // =========================================================
    // ðŸŒŸ 1. ANA ANALÄ°Z METODU (BU METOT GÃœNCELLENDÄ°)
    // =========================================================
    public String analyzeJobSubmission(UserProfile user, String rawJobText) {
        // KullanÄ±cÄ± profilini (Diller dahil!) metne dÃ¶kÃ¼yoruz
        String userContext = formatUserProfile(user);

        // Prompt'u hazÄ±rlÄ±yoruz
        String prompt = String.format(
            "SEN BÄ°R Ä°K UZMANI VE TEKNÄ°K ANALÄ°STSÄ°N.\n" +
            "AÅŸaÄŸÄ±daki Ä°Åž Ä°LANI ile ADAY PROFÄ°LÄ°NÄ° karÅŸÄ±laÅŸtÄ±r ve analiz et.\n\n" +
            "--- ADAY PROFÄ°LÄ° ---\n%s\n\n" +
            "--- Ä°Åž Ä°LANI ---\n%s\n\n" +
            "GÃ–REVLER:\n" +
            "1. Ä°lanÄ±n temel bilgilerini Ã§Ä±kar (Firma, Pozisyon, Konum).\n" +
            "2. AdayÄ±n yeteneklerini VE DÄ°LLERÄ°NÄ° ilanla kÄ±yasla.\n" +
            "âš ï¸ Ã–NEMLÄ° KURAL: AdayÄ±n profilindeki diller (Ã–rn: 'Ä°NGÄ°LÄ°ZCE') ile ilandaki diller (Ã–rn: 'English', 'Ä°ngilizce') eÅŸleÅŸiyorsa bunu KESÄ°NLÄ°KLE 'Mevcut' olarak iÅŸaretle. BÃ¼yÃ¼k/kÃ¼Ã§Ã¼k harf duyarlÄ±lÄ±ÄŸÄ± yapma.\n" +
            "3. Eksik olanlarÄ± ve tam eÅŸleÅŸenleri belirle.\n\n" +
            "Ä°STENEN Ã‡IKTI FORMATI (Aynen bu formatÄ± kullan, emojileri silme):\n" +
            "Pozisyon DetaylarÄ±: Ä°lan baÅŸlÄ±ÄŸÄ± + pozisyon seviyesi (Junior/Mid/Senior)" +
            "**ðŸ¢ Firma:** (Firma AdÄ±)\n" +
            "**ðŸ“ Konum:** (Åžehir/Ä°lÃ§e)\n" +
            "**ðŸ’¼ Ã‡alÄ±ÅŸma Tipi:** (Tam ZamanlÄ±/Hibrit vb.)\n\n" +
            "#### ðŸ›  **Mesleki Gereklilikler**\n" +
            "- â˜‘ [Adayda Olan Yetenek/Dil]\n" +
            "- âŒ **[Adayda Olmayan Yetenek/Dil]** (Eksik)\n\n" +
            "#### ðŸ“‹ **Sorumluluklar**\n" +
            "- (Ä°landaki sorumluluklarÄ± maddeler halinde Ã¶zetle)\n",
            userContext,
            rawJobText
        );

        try {
            return translationService.generateContent(prompt);
        } catch (Exception e) {
            log.error("AI Analiz HatasÄ±: ", e);
            return "Analiz servisine ulaÅŸÄ±lamadÄ±.";
        }
    }

    // =========================================================
    // ðŸŒŸ 2. YARDIMCI METOT: Profil Formatlama (Dilleri Ekledik!)
    // =========================================================
    private String formatUserProfile(UserProfile user) {
        if (user == null) return "Anonim KullanÄ±cÄ±";
        
        StringBuilder sb = new StringBuilder();
        
        // 1. Yetenekleri Ekle
        if (user.getSkills() != null && !user.getSkills().isEmpty()) {
            String skills = user.getSkills().stream()
                .map(UserSkill::getSkillName)
                .collect(Collectors.joining(", "));
            sb.append("Teknik Yetenekler: ").append(skills).append("\n");
        }
        
        // 2. DÄ°LLERÄ° EKLE (Sorunun Ã‡Ã¶zÃ¼mÃ¼ BurasÄ±)
        if (user.getLanguages() != null && !user.getLanguages().isEmpty()) {
            String langs = user.getLanguages().stream()
                .map(l -> l.getLanguage() + " (Seviye: " + l.getLevel() + ")")
                .collect(Collectors.joining(", "));
            sb.append("YabancÄ± Diller: ").append(langs).append("\n");
        } else {
            sb.append("YabancÄ± Diller: BelirtilmemiÅŸ\n");
        }
        
        // 3. Deneyim Ã–zeti
        if (user.getTotalExperienceYear() != null) {
            sb.append("Toplam Deneyim: ").append(user.getTotalExperienceYear()).append(" YÄ±l\n");
        }

        return sb.toString();
    }

    // =========================================================
    // 3. JSON ANALÄ°ZÄ° (Eski veya Alternatif KullanÄ±m Ä°Ã§in)
    // =========================================================
    public String analyzeJobPostingUniversal(String rawJobText) {
        String prompt = String.format(
            "Bu iÅŸ ilanÄ±nÄ± analiz et ve sadece JSON dÃ¶ndÃ¼r:\n%s\n" +
            "Format: { \"position\": \"...\", \"technicalSkills\": [\"...\"], ... }",
            rawJobText
        );
        try {
            String response = translationService.generateContent(prompt);
            return response != null ? response.replaceAll("```json|```", "").trim() : "{}";
        } catch (Exception e) {
            return "{}";
        }
    }

    // =========================================================
    // 4. KARÄ°YER TAVSÄ°YESÄ° (SektÃ¶rel Analiz)
    // =========================================================
    public String getCareerAdvice(String jobTitle) {
        if (jobTitle == null || jobTitle.isBlank()) return "Tavsiye oluÅŸturulamadÄ±.";
        String prompt = "Kariyer danÄ±ÅŸmanÄ± olarak '" + jobTitle + "' pozisyonu iÃ§in trendleri ve geliÅŸim Ã¶nerilerini TÃ¼rkÃ§e maddeler halinde yaz.";
        try {
            return translationService.generateContent(prompt);
        } catch (Exception e) {
            return "Servis meÅŸgul.";
        }
    }

    // =========================================================
    // 5. CV OPTÄ°MÄ°ZASYON METOTLARI
    // =========================================================

    public List<String> generateTailoredSummaries(UserProfile profile, String jobContext) {
        String rawTitle = profile != null ? safe(profile.getTitle()) : "Profesyonel";
        String userTitle = toTitleCase(rawTitle);
        String skills = getPrioritizedSkills(profile, jobContext);
        int years = (profile != null && profile.getTotalExperienceYear() != null) ? profile.getTotalExperienceYear() : 0;

        List<String> summaries = new ArrayList<>();
        summaries.add(String.format("%s deneyime sahip bir %s olarak, **%s** alanlarÄ±ndaki yetkinliÄŸimle deÄŸer katmayÄ± hedefliyorum.", 
            years > 0 ? years + " yÄ±l" : "Yeni mezun", userTitle, skills));
        
        // AI Summary
        String aiSummary = generateCreativeAiSummary(userTitle, skills, years);
        if (!aiSummary.isEmpty()) summaries.add(aiSummary);

        return summaries;
    }

    public List<OptimizedCvItem> optimizeExperiences(UserProfile profile, JobPosting job) {
        if (profile == null || profile.getExperiences() == null) return Collections.emptyList();
        String jobSkills = (job != null) ? safe(job.getRequiredSkills()) : "";

        return profile.getExperiences().stream().map(exp -> {
            String desc = safe(exp.getDescription());
            if (desc.length() > 10) desc = fixGrammarStrict(desc);
            
            String matched = findIntersection(desc, jobSkills);
            if (!matched.isEmpty()) {
                desc += " Bu gÃ¶revde **" + matched + "** yetkinliklerini aktif olarak kullandÄ±m.";
            }
            
            return new OptimizedCvItem(
                safe(exp.getPosition()), 
                safe(exp.getCompany()), 
                formatDateRange(exp.getStartDate(), exp.getEndDate()), 
                List.of(desc)
            );
        }).collect(Collectors.toList());
    }

    public List<OptimizedCvItem> optimizeProjects(UserProfile profile, JobPosting job) {
        if (profile == null || profile.getProjects() == null) return Collections.emptyList();
        return profile.getProjects().stream().map(p -> new OptimizedCvItem(
                safe(p.getProjectName()), "Proje", 
                formatDateRange(p.getStartDate(), p.getIsOngoing() ? null : p.getEndDate()), 
                List.of(fixGrammarStrict(safe(p.getDescription())))
        )).collect(Collectors.toList());
    }
    
    // DTO Helper Methods
    public List<UserEducationDTO> optimizeEducation(UserProfile profile, JobPosting job) {
        if (profile == null || profile.getEducations() == null) return Collections.emptyList();
        return profile.getEducations().stream().map(e -> UserEducationDTO.builder()
                .id(e.getId())
                .schoolName(fixGrammarStrict(safe(e.getSchoolName())))
                .department(fixGrammarStrict(safe(e.getDepartment())))
                .degree(safe(e.getDegree()))
                .startYear(safe(e.getStartYear()))
                .graduationYear(e.getEndYear())
                .gpa(safe(e.getGpa()))
                .build()).collect(Collectors.toList());
    }

    public List<UserLanguageDTO> optimizeLanguages(UserProfile profile, JobPosting job) {
        if(profile == null || profile.getLanguages() == null) return Collections.emptyList();
        return profile.getLanguages().stream().map(l -> UserLanguageDTO.builder()
                .id(l.getId()).language(safe(l.getLanguage())).level(safe(l.getLevel())).build()).collect(Collectors.toList());
    }

    public List<UserCertificateDTO> optimizeCertificates(UserProfile profile, JobPosting job) {
        if(profile == null || profile.getCertificates() == null) return Collections.emptyList();
        return profile.getCertificates().stream().map(c -> UserCertificateDTO.builder()
                .id(c.getId()).name(safe(c.getName())).issuer(safe(c.getIssuer())).date(safe(c.getDate())).url(safe(c.getUrl())).build()).collect(Collectors.toList());
    }

    // --- YARDIMCI METOTLAR ---

    private String getPrioritizedSkills(UserProfile profile, String jobContext) {
        if (profile == null || profile.getSkills() == null) return "Mesleki Yetkinlikler";
        return profile.getSkills().stream().limit(5).map(UserSkill::getSkillName).collect(Collectors.joining(", "));
    }

    private String generateCreativeAiSummary(String title, String skills, int years) {
        try {
            String res = translationService.generateContent(String.format("Bir %s iÃ§in %d yÄ±l deneyimli, ÅŸu yeteneklere sahip: %s. KÄ±sa Ã¶zet yaz.", title, years, skills));
            return res != null ? res.replace("\"", "").trim() : "";
        } catch (Exception e) { return ""; }
    }

    private String fixGrammarStrict(String text) {
        if (text == null || text.length() < 5) return text;
        try {
            String res = translationService.generateContent("Metni dilbilgisi kurallarÄ±na gÃ¶re dÃ¼zelt: " + text);
            return res != null ? res.trim() : text;
        } catch (Exception e) { return text; }
    }

    private String findIntersection(String text, String skills) {
        if (text == null || skills == null) return "";
        Set<String> match = new HashSet<>();
        String tLower = text.toLowerCase(Locale.ENGLISH);
        for (String s : skills.split("[,;]")) {
            if (tLower.contains(s.trim().toLowerCase(Locale.ENGLISH))) match.add(s.trim());
        }
        return String.join(", ", match);
    }

    private String toTitleCase(String input) {
        if (input == null || input.isEmpty()) return "";
        return Arrays.stream(input.trim().split("\\s+"))
                .map(w -> w.isEmpty() ? "" : Character.toUpperCase(w.charAt(0)) + w.substring(1).toLowerCase(Locale.forLanguageTag("tr")))
                .collect(Collectors.joining(" "));
    }

    private String safe(String text) { return text != null ? text : ""; }

    private String formatDateRange(String start, String end) {
        return (start != null ? start : "") + (end != null ? " - " + end : " - Devam Ediyor");
    }
}