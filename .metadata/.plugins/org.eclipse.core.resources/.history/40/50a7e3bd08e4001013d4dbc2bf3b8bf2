package com.cvbuilder.external;

import com.cvbuilder.dto.OptimizedCvItem;
import com.cvbuilder.dto.UserCertificateDTO;
import com.cvbuilder.dto.UserEducationDTO;
import com.cvbuilder.dto.UserLanguageDTO;
import com.cvbuilder.entity.JobPosting;
import com.cvbuilder.entity.UserProfile;
import com.cvbuilder.service.TranslationService;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Component;
import java.util.*;
import java.util.stream.Collectors;

@Slf4j
@Component
@RequiredArgsConstructor
public class AiClient {

    private final TranslationService translationService;

    /**
     * İŞ ANALİZİ: Profil ile iş ilanını ATS kriterlerine göre karşılaştırır.
     */
    public String analyzeJobSubmission(UserProfile user, String rawJobText) {
        String prompt = String.format("""
            ADAY PROFİLİ: %s
            İŞ İLANI: %s
            GÖREVİN: Adayın bu işe uygunluğunu analiz et. Eşleşenleri ve eksikleri profesyonelce raporla.
            """, formatUserProfile(user), rawJobText);
        return translationService.generateContent(prompt);
    }

    /**
     * PAZAR ANALİZİ: Toplu ilan verisi üzerinden trend belirler.
     */
    public String analyzeMarketWithAI(String area, List<JobPosting> allJobs, UserProfile user) {
        String jobsSummary = allJobs.stream()
                .map(j -> j.getPosition() + " - " + j.getRequiredSkills())
                .collect(Collectors.joining("\n"));
        
        String prompt = String.format("""
            HEDEF ALAN: %s
            MEVCUT İLANLAR: %s
            ADAY PROFİLİ: %s
            GÖREVİN: Pazardaki en çok istenen 10 beceriyi belirle ve adaya gelişim yol haritası sun.
            """, area, jobsSummary, formatUserProfile(user));
        return translationService.generateContent(prompt);
    }

    /**
     * CV OPTİMİZASYONU: Deneyimleri iş ilanına göre yeniden düzenler.
     */
    public List<OptimizedCvItem> optimizeExperiences(UserProfile profile, JobPosting job) {
        if (profile.getExperiences() == null) return Collections.emptyList();
        return profile.getExperiences().stream().map(exp -> {
            String optimizedDesc = translationService.generateContent(
                "Bu iş deneyimi açıklamasını şu iş ilanına göre ATS uyumlu hale getir: " + exp.getDescription()
            );
            return new OptimizedCvItem(exp.getPosition(), exp.getCompany(), 
                                      exp.getStartDate() + " - " + exp.getEndDate(), 
                                      Collections.singletonList(optimizedDesc));
        }).collect(Collectors.toList());
    }

    // Diğer DTO dönüşümleri (Örnekleme amaçlı basitleştirilmiştir)
    public List<UserEducationDTO> optimizeEducation(UserProfile p, JobPosting j) {
        return p.getEducations().stream().map(e -> UserEducationDTO.builder()
                .schoolName(e.getSchoolName()).department(e.getDepartment()).build()).collect(Collectors.toList());
    }

    public List<String> generateTailoredSummaries(UserProfile p, String context) {
        String aiSummary = translationService.generateContent("Şu profile ve işe uygun 2 cümlelik özet yaz: " + context);
        return Collections.singletonList(aiSummary);
    }

    public String getCareerAdvice(String title) {
        return translationService.generateContent(title + " pozisyonu için kariyer tavsiyeleri ver.");
    }

 // busrakurt1/cv-builder-proje/cv-builder-proje-28.12-bitirme/external/AiClient.java

    public String analyzeJobPostingUniversal(String rawJobText) {
        if (rawJobText == null || rawJobText.isBlank()) return "{}";

        // AI'nın sadece saf JSON dönmesini zorunlu kılan katı prompt
        String prompt = String.format(
                "SEN BİR İŞ İLANI ANALİZ MAKİNESİSİN. Aşağıdaki iş ilanını analiz et ve SADECE JSON DÖNDÜR. " +
                "Yanıtında asla açıklama yapma, giriş cümlesi yazma. " +
                "Yanıtın doğrudan '{' ile başlamalı ve '}' ile bitmeli.\n\n" +
                
                "ANALİZ EDİLECEK İŞ İLANI METNİ:\n%s\n\n" +
                
                "JSON ŞEMASI - TÜM BU ALANLARI DOLDUR:\n" +
                "{\n" +
                "  \"position\": \"Pozisyon adı (örn: Azure Cloud Stajyeri, Backend Developer)\",\n" +
                "  \"company\": \"Şirket adı (eğer yoksa 'Bilinmiyor' yaz)\",\n" +
                "  \"location\": \"Konum/Şehir (eğer yoksa 'Belirtilmemiş' yaz)\",\n" +
                "  \"workType\": \"Çalışma tipi (Tam zamanlı, Yarı zamanlı, Staj, Remote vs.)\",\n" +
                "  \"experienceLevel\": \"Deneyim seviyesi (Stajyer, Junior, Mid, Senior, Yönetici)\",\n" +
                "  \"educationLevel\": \"Eğitim seviyesi (Lisans, Yüksek Lisans, Doktora, Lise)\",\n" +
                "  \"technicalSkills\": [\"Azure\", \"Python\", \".NET\", \"DevOps\", \"...\"],\n" +
                "  \"softSkills\": [\"Takım çalışması\", \"İletişim\", \"...\"],\n" +
                "  \"responsibilities\": [\"Görev 1\", \"Görev 2\", \"...\"],\n" +
                "  \"requirements\": [\"Şart 1\", \"Şart 2\", \"...\"],\n" +
                "  \"preferredQualifications\": [\"Tercih edilen 1\", \"Tercih edilen 2\", \"...\"],\n" +
                "  \"summary\": \"İşin 2-3 cümlelik özeti\",\n" +
                "  \"matchScore\": 0,\n" +
                "  \"missingSkills\": [\"Eksik yetenek 1\", \"Eksik yetenek 2\", \"...\"]\n" +
                "}\n\n" +
                
                "ÖNEMLİ KURALLAR:\n" +
                "1. Eğer metinde bilgi yoksa 'Belirtilmemiş' veya [] kullan\n" +
                "2. technicalSkills'i metinden çıkar\n" +
                "3. matchScore her zaman 0 olarak başlasın\n" +
                "4. missingSkills'i şimdilik boş bırak\n" +
                "5. SADECE JSON döndür, başka hiçbir şey yazma!",
                rawJobText
        );
        try {
            String response = translationService.generateContent(prompt);
            if (response == null) return "{}";
            
            // AI bazen tüm uyarılara rağmen ```json ... ``` bloğu dönebilir.
            // Aşağıdaki regex, metin içindeki ilk { ve son } arasındaki kısmı ayıklar.
            String cleanJson = response.replaceAll("(?s)^.*?(\\{.*\\}).*$", "$1").trim();
            
            return cleanJson;
        } catch (Exception e) {
            log.error("AI JSON Analiz Hatası: ", e);
            return "{}";
        }
    }
    private String formatUserProfile(UserProfile user) {
        if (user == null) return "Profil Bilgisi Yok";
        return String.format("Unvan: %s, Yetenekler: %s", user.getTitle(), 
            user.getSkills().stream().map(s -> s.getSkillName()).collect(Collectors.joining(", ")));
    }

    // Gerekli diğer optimize metotları (Sertifika, Dil vb.) CvGeneratorServiceImpl'deki çağrılara göre eklenmelidir.
    public List<OptimizedCvItem> optimizeProjects(UserProfile p, JobPosting j) { return Collections.emptyList(); }
    public List<UserLanguageDTO> optimizeLanguages(UserProfile p, JobPosting j) { return Collections.emptyList(); }
    public List<UserCertificateDTO> optimizeCertificates(UserProfile p, JobPosting j) { return Collections.emptyList(); }
}