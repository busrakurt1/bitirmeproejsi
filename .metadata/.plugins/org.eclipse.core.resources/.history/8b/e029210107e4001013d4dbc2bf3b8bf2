package com.cvbuilder.external;

import org.jsoup.Connection;
import org.jsoup.Jsoup;
import org.jsoup.nodes.Document;
import org.jsoup.nodes.Element;
import org.jsoup.select.Elements;
import org.springframework.stereotype.Component;
import java.io.IOException;
import java.util.HashMap;
import java.util.Map;
import lombok.extern.slf4j.Slf4j;

@Slf4j
@Component
public class JobScraperClient {

    private static final Map<String, String[]> SITE_SELECTORS = new HashMap<>();
    
    static {
        // Kariyer.net i√ßin selector'lar g√ºncellendi ve geni≈ületildi
    	// JobScraperClient.java i√ßinde Kariyer.net selector listesini g√ºncelleyin
    	SITE_SELECTORS.put("kariyer.net", new String[]{
    	    ".job-detail-content", 
    	    ".description", 
    	    ".job-description",
    	    "div[class*='job-detail']",
    	    "main" // En k√∂t√º ihtimalle ana g√∂vdeyi al
    	});
        
        SITE_SELECTORS.put("linkedin.com", new String[]{
            ".description__text", 
            ".show-more-less-html__markup",
            ".jobs-description__content"
        });
    }

    public Map<String, String> fetchJobData(String url) {
        Map<String, String> result = new HashMap<>();
        log.info("üåê ƒ∞lan √ßekiliyor: {}", url);
        
        try {
            Connection.Response response = Jsoup.connect(url)
                    .userAgent("Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.0.0 Safari/537.36")
                    .header("Accept-Language", "tr-TR,tr;q=0.9,en-US;q=0.8,en;q=0.7")
                    .header("Accept", "text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8")
                    .referrer("https://www.google.com/")
                    .ignoreHttpErrors(true)
                    .followRedirects(true)
                    .timeout(30000)
                    .execute();

            Document doc = response.parse();
            result.put("pageTitle", doc.title());
            
            // 1. Siteye √∂zel selector ile i√ßerik √ßekme
            String jobContent = extractJobSpecificContent(doc, url);
            
            // 2. Eƒüer √∂zel i√ßerik bo≈üsa veya √ßok kƒ±saysa yedek mekanizma (Fallback)
            if (jobContent == null || jobContent.trim().length() < 100) {
                log.warn("‚ö†Ô∏è √ñzel selector sonu√ß vermedi, sayfa metni temizleniyor...");
                jobContent = cleanBodyText(doc.body());
            }

            result.put("jobContent", jobContent);
            result.put("location", extractFromMeta(doc, "location", "place", "og:description"));
            result.put("company", extractFromMeta(doc, "company", "organization", "og:title"));
            
            log.info("‚úÖ ƒ∞lan i√ßeriƒüi ba≈üarƒ±yla √ßekildi (Karakter sayƒ±sƒ±: {})", jobContent.length());
            return result;

        } catch (IOException e) {
            log.error("‚ùå ƒ∞lan √ßekme hatasƒ±: {}", e.getMessage());
            throw new RuntimeException("ƒ∞lan verisi √ßekilemedi: " + e.getMessage());
        }
    }
    
 // JobScraperClient.java i√ßindeki metotlarƒ± bu ≈üekilde g√ºncelleyin

    private String extractJobSpecificContent(Document doc, String url) {
        // Kariyer.net i√ßin eklenen √∂zel √∂nlem: JSON-LD verisini ayƒ±klamaya √ßalƒ±≈ü
        // Bir√ßok site ilan detaylarƒ±nƒ± script etiketleri i√ßinde JSON olarak tutar
        Elements scripts = doc.select("script[type='application/ld+json']");
        for (Element script : scripts) {
            String html = script.html();
            if (html.contains("JobPosting")) {
                // Buradaki metni basit√ße temizleyip d√∂nd√ºrebiliriz
                return html.replaceAll("\\{.*?\\}", "").replaceAll("[\"}{]", "").trim();
            }
        }

        // Normal selector mantƒ±ƒüƒ± devam etsin
        for (Map.Entry<String, String[]> entry : SITE_SELECTORS.entrySet()) {
            if (url.contains(entry.getKey())) {
                for (String selector : entry.getValue()) {
                    Elements elements = doc.select(selector);
                    String text = elements.text().trim();
                    if (text.length() > 100) return text;
                }
            }
        }
        return "";
    }

    private String cleanBodyText(Element body) {
        if (body == null) return "";
        Element content = body.clone();
        
        // Sadece ilanla ilgili olabilecek yerleri bƒ±rak, geri kalan her ≈üeyi (header, footer, nav) sil
        content.select("script, style, link, nav, header, footer, aside, .sidebar, .menu, .ads").remove();
        
        String text = content.text().trim();
        
        // Eƒüer hala bo≈üsa, bot korumasƒ±na takƒ±lmƒ±≈üƒ±z demektir.
        if (text.length() < 50) {
            log.error("‚ùå Bot korumasƒ± veya Bo≈ü Sayfa: ƒ∞√ßerik √ßekilemedi.");
            return ""; 
        }
        return text;
    }
    
    private String extractFromMeta(Document doc, String... keys) {
        for (String key : keys) {
            Element meta = doc.select("meta[name=" + key + "], meta[property=" + key + "]").first();
            if (meta != null) {
                return meta.attr("content");
            }
        }
        return "";
    }
}