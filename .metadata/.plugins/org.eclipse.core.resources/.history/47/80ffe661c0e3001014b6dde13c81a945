package com.cvbuilder.external;

import io.github.bonigarcia.wdm.WebDriverManager;
import org.openqa.selenium.WebDriver;
import org.openqa.selenium.chrome.ChromeDriver;
import org.openqa.selenium.chrome.ChromeOptions;
import org.jsoup.Jsoup;
import org.jsoup.nodes.Document;
import org.jsoup.nodes.Element;
import org.jsoup.select.Elements;
import org.springframework.stereotype.Component;

import java.time.Duration;
import java.util.HashMap;
import java.util.Map;

@Component
public class JobScraperClient {

    private static final Map<String, String[]> SITE_SELECTORS = new HashMap<>();

    static {
        // Site bazlı selector tanımlamaları (Orijinal haliyle korundu)
        SITE_SELECTORS.put("kariyer.net", new String[]{
                "#job-detail > div:nth-child(1) > div > div:nth-child(2)",
                "div[class*='job-detail']",
                "section.job-detail-content"
        });

        SITE_SELECTORS.put("linkedin.com", new String[]{
                ".description__text",
                ".show-more-less-html__markup",
                ".jobs-description__content"
        });

        SITE_SELECTORS.put("yenibiris.com", new String[]{
                ".job-detail-content",
                ".detail-text"
        });

        SITE_SELECTORS.put("eleman.net", new String[]{
                ".ilanDetay",
                "#jobDetail"
        });
    }

    public Map<String, String> fetchJobData(String url) {
        Map<String, String> result = new HashMap<>();
        result.put("url", url);

        // 1. ADIM: Selenium Ayarları (Gerçek Tarayıcı Taklidi)
        WebDriverManager.chromedriver().setup();
        ChromeOptions options = new ChromeOptions();
        options.addArguments("--headless"); // Arka planda çalışır, pencere açmaz
        options.addArguments("--disable-gpu");
        options.addArguments("--no-sandbox");
        options.addArguments("--disable-dev-shm-usage");
        options.addArguments("user-agent=Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36");

        WebDriver driver = new ChromeDriver(options);

        try {
            // 2. ADIM: Sayfayı Gerçek Bir Tarayıcı Gibi Yükle
            driver.get(url);
            // Kariyer.net'in içeriği yüklemesi için 5 saniye bekle
            Thread.sleep(5000);

            // Selenium'un çektiği "canlı" HTML kodunu Jsoup'a aktar
            String htmlContent = driver.getPageSource();
            Document doc = Jsoup.parse(htmlContent);

            // 3. ADIM: Senin Orijinal Analiz Mantığın (Dokunulmadı)
            String pageTitle = doc.title();
            result.put("pageTitle", pageTitle);

            String jobContent = extractJobSpecificContent(doc, url);
            result.put("jobContent", jobContent);
            result.put("description", jobContent); // Analiz için kritik alan

            result.put("location", extractFromMeta(doc, "location", "place"));
            result.put("company", extractFromMeta(doc, "company", "organization"));

            String structuredData = extractStructuredData(doc);
            if (!structuredData.isEmpty()) {
                result.put("structuredData", structuredData);
            }

            result.put("fullText", doc.body().text());

            return result;

        } catch (Exception e) {
            System.err.println("Selenium/Scraping Hatası: " + e.getMessage());
            throw new RuntimeException("İlan çekilemedi: " + e.getMessage());
        } finally {
            // Belleği temizlemek için tarayıcıyı kapat
            driver.quit();
        }
    }

    // --- SENİN ORİJİNAL YARDIMCI METODLARIN (HİÇBİR ŞEY ÇIKARTILMADI) ---

    private String extractJobSpecificContent(Document doc, String url) {
        for (Map.Entry<String, String[]> entry : SITE_SELECTORS.entrySet()) {
            if (url.contains(entry.getKey())) {
                for (String selector : entry.getValue()) {
                    Elements elements = doc.select(selector);
                    if (!elements.isEmpty()) {
                        StringBuilder content = new StringBuilder();
                        for (Element el : elements) {
                            content.append(el.text()).append("\n");
                        }
                        return content.toString();
                    }
                }
            }
        }

        Elements likelySections = doc.select(
                "div[class*='job'], div[class*='detail'], div[class*='description'], " +
                "section[class*='content'], div[class*='position'], div[class*='requirement']"
        );

        if (!likelySections.isEmpty()) {
            StringBuilder content = new StringBuilder();
            for (Element el : likelySections) {
                String text = el.text().toLowerCase();
                if (text.contains("aranan") || text.contains("sorumluluk") ||
                    text.contains("nitelik") || text.contains("beceri") ||
                    text.contains("tecrübe") || text.contains("yetenek")) {
                    content.append(el.text()).append("\n");
                }
            }
            if (content.length() > 100) return content.toString();
        }

        return cleanBodyText(doc.body());
    }

    private String cleanBodyText(Element body) {
        body.select("nav, header, footer, script, style, iframe, .nav, .menu, .sidebar").remove();
        return body.text();
    }

    private String extractFromMeta(Document doc, String... keys) {
        for (String key : keys) {
            Element meta = doc.select("meta[name=" + key + "], meta[property=" + key + "]").first();
            if (meta != null) return meta.attr("content");
        }
        return "";
    }

    private String extractStructuredData(Document doc) {
        Elements scripts = doc.select("script[type='application/ld+json']");
        for (Element script : scripts) {
            if (script.html().contains("\"@type\":\"JobPosting\"")) {
                return script.html();
            }
        }
        return "";
    }
}