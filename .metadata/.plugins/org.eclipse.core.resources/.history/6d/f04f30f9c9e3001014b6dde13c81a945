package com.cvbuilder.service;

import com.cvbuilder.dto.JobAnalysisResponse;
import com.cvbuilder.dto.MarketAnalysisResponse;
import com.cvbuilder.entity.JobPosting;
import com.cvbuilder.entity.User;
import com.cvbuilder.entity.UserProfile;
import com.cvbuilder.entity.UserSkill;
import com.cvbuilder.external.AiClient;
import com.cvbuilder.external.JobScraperClient;
import com.cvbuilder.repository.JobPostingRepository;
import com.cvbuilder.repository.UserProfileRepository;
import com.cvbuilder.repository.UserRepository;
import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Sort;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.*;
import java.util.stream.Collectors;
import java.util.stream.StreamSupport;

@Slf4j
@Service
@RequiredArgsConstructor
public class JobAnalysisServiceImpl implements JobAnalysisService {

    private final UserRepository userRepository;
    private final UserProfileRepository userProfileRepository;
    private final JobPostingRepository jobPostingRepository;
    private final JobScraperClient scraper;
    private final AiClient aiClient;
    private final ObjectMapper objectMapper;

    @Override
    @Transactional
    public JobAnalysisResponse analyzeJobPosting(Long userId, String url) {
        log.info("Analyzing Job for User ID: {}, URL: {}", userId, url);
        User user = userRepository.findById(userId).orElseThrow(() -> new RuntimeException("KullanÄ±cÄ± bulunamadÄ±"));
        Map<String, String> scrapedData = scraper.fetchJobData(url);
        String jobContent = scrapedData.getOrDefault("jobContent", scrapedData.getOrDefault("fullText", ""));
        String jsonResult = aiClient.analyzeJobPostingUniversal(jobContent);
        JobAiResult aiData = parseAiResult(jsonResult);
        List<String> userSkills = getUserSkillsNormalized(user);
        List<String> matchedSkills = new ArrayList<>();
        List<String> missingSkills = new ArrayList<>();
        for (String reqSkill : aiData.technicalSkills) {
            if (isUserHasSkill(userSkills, reqSkill)) matchedSkills.add(reqSkill);
            else missingSkills.add(reqSkill);
        }
        String report = generateUniversalReport(aiData, matchedSkills);
        JobPosting jp = saveJobPosting(user, url, aiData, jobContent, report);
        int totalReq = aiData.technicalSkills.size();
        int matchedCount = matchedSkills.size();
        int score = totalReq == 0 ? 0 : (int) Math.round((matchedCount * 100.0) / totalReq);
        return JobAnalysisResponse.builder().jobId(jp.getId()).matchedSkills(matchedSkills).missingSkills(missingSkills).position(emptyToUnspecified(aiData.position)).company(emptyToUnspecified(aiData.company)).location(emptyToUnspecified(aiData.location)).workType(emptyToUnspecified(aiData.workType)).experienceLevel(emptyToUnspecified(aiData.experienceLevel)).educationLevel(emptyToUnspecified(aiData.educationLevel)).militaryStatus(emptyToUnspecified(aiData.militaryStatus)).salary(emptyToUnspecified(aiData.salary)).summary(emptyToUnspecified(aiData.summary)).responsibilities(aiData.responsibilities).matchScore(score).formattedAnalysis(report).build();
    }

    // =================================================================================
    // ðŸ“Š PAZAR ANALÄ°ZÄ° - DÄ°NAMÄ°K FÄ°LTRELEME EKLENDÄ°
    // =================================================================================
    @Override
    @Transactional(readOnly = true)
    public MarketAnalysisResponse performMarketAnalysis(String area, Long userId) {
        log.info("Performing market analysis. Requested Area: {}, userId: {}", area, userId);
        
        UserProfile userProfile = userProfileRepository.findByUserId(userId)
                .orElseThrow(() -> new RuntimeException("KullanÄ±cÄ± profili bulunamadÄ±"));
        
        // EÄžER area parametresi boÅŸ gelirse kullanÄ±cÄ±nÄ±n kendi unvanÄ±nÄ±/bÃ¶lÃ¼mÃ¼nÃ¼ kullan
        String targetSearch = (area == null || area.trim().isEmpty()) ? userProfile.getTitle() : area.trim();
        
        log.info("Searching job postings for keyword: {}", targetSearch);

        // --- DÃœZELTME: Sadece aranan kelimeyi iÃ§eren ilanlarÄ± getir ---
        List<JobPosting> filteredJobs = jobPostingRepository.findTop100ByPositionContainingIgnoreCaseOrderByCreatedAtDesc(targetSearch);
        
        // EÄŸer filtreye gÃ¶re hiÃ§ ilan bulunamazsa kullanÄ±cÄ±yÄ± uyar veya genel havuzu Ã§ek (Tercih: BoÅŸ kalmasÄ±n diye genel Ã§ekiyoruz ama AI'ya durumu bildiriyoruz)
        boolean isGeneralPool = false;
        if (filteredJobs.isEmpty()) {
            isGeneralPool = true;
            filteredJobs = jobPostingRepository.findAll(PageRequest.of(0, 100, Sort.by(Sort.Direction.DESC, "createdAt"))).getContent();
        }
        
        // Frekans Analizi
        Set<String> userSkills = getUserSkillSet(userProfile);
        Map<String, Integer> skillFrequencies = new HashMap<>();
        for (JobPosting job : filteredJobs) {
            Set<String> extracted = extractSkillsFromJobPosting(job);
            for (String s : extracted) {
                skillFrequencies.put(s, skillFrequencies.getOrDefault(s, 0) + 1);
            }
        }

        // Eksik yetenekleri belirle
        List<String> userMissingSkills = skillFrequencies.entrySet().stream()
                .sorted(Map.Entry.<String, Integer>comparingByValue().reversed())
                .filter(entry -> !checkIfUserHasSkill(entry.getKey(), userSkills))
                .limit(5)
                .map(entry -> capitalizeFirstLetter(entry.getKey()))
                .collect(Collectors.toList());

        // AI Ä°statistiÄŸi
        final int totalFound = filteredJobs.size();
        String statsSummary = skillFrequencies.entrySet().stream()
                .sorted(Map.Entry.<String, Integer>comparingByValue().reversed())
                .limit(12)
                .map(e -> e.getKey() + ": %" + (e.getValue() * 100 / totalFound))
                .collect(Collectors.joining(", "));

        String aiPrompt = String.format(
            "Sen profesyonel bir kariyer danÄ±ÅŸmanÄ±sÄ±n. KullanÄ±cÄ± ÅŸu alanda analiz istiyor: %s. " +
            "VeritabanÄ±ndaki son 100 ilanÄ±n teknik Ã¶zeti: [%s]. " +
            "KullanÄ±cÄ±nÄ±n mevcut yetenekleri: [%s]. " +
            "LÃ¼tfen kullanÄ±cÄ±nÄ±n profilini bu pazar verisiyle kÄ±yasla. %s alanÄ±nda en Ã§ok talep edilen ama kullanÄ±cÄ±da olmayan " +
            "kritik teknolojileri belirterek (Ã¶rneÄŸin Makine MÃ¼hendisi ise SolidWorks, YazÄ±lÄ±mcÄ± ise Java gibi) " +
            "maksimum 4 cÃ¼mlelik motive edici bir geliÅŸim tavsiyesi yaz.",
            targetSearch, statsSummary, String.join(", ", userSkills), targetSearch
        );

        String aiAdvice = aiClient.generateTailoredSummary(userProfile, aiPrompt);
        
        return MarketAnalysisResponse.builder()
                .area(targetSearch)
                .userTitle(userProfile.getTitle())
                .topSkillsInMarket(skillFrequencies)
                .userMissingSkills(userMissingSkills)
                .aiRecommendation(aiAdvice)
                .build();
    }

    // --- YARDIMCI METOTLAR ---
    private Set<String> getUserSkillSet(UserProfile userProfile) {
        Set<String> skills = new HashSet<>();
        if (userProfile.getSkills() != null) {
            for (UserSkill s : userProfile.getSkills()) {
                if (s.getSkillName() != null) skills.add(s.getSkillName().toLowerCase().trim());
            }
        }
        return skills;
    }

    private Set<String> extractSkillsFromJobPosting(JobPosting job) {
        Set<String> skills = new HashSet<>();
        if (job.getRequiredSkills() != null) {
            String[] parts = job.getRequiredSkills().split("[,;\\n\\|]");
            for (String p : parts) {
                String t = p.trim().toLowerCase().replaceAll("[.()\\{\\}\\[\\]]", "");
                if (t.length() > 2) skills.add(t);
            }
        }
        if (job.getCleanedText() != null) {
            String text = job.getCleanedText().toLowerCase();
            String[] techList = {"java", "python", "javascript", "typescript", "spring boot", "react", "docker", "aws", "sql", "solidworks", "autocad", "inventor", "matlab", "c#", "kubernetes"};
            for (String tech : techList) { if (text.contains(tech)) skills.add(tech); }
        }
        return skills;
    }

    private boolean checkIfUserHasSkill(String marketSkill, Set<String> userSkills) {
        String ms = marketSkill.toLowerCase();
        return userSkills.stream().anyMatch(us -> ms.contains(us) || us.contains(ms));
    }

    private String capitalizeFirstLetter(String text) {
        if (text == null || text.isEmpty()) return text;
        return text.substring(0, 1).toUpperCase() + text.substring(1);
    }

    private String safeTruncate(String v, int l) {
        if (v == null) return "";
        return v.length() > l ? v.substring(0, l - 3) + "..." : v;
    }

    private String emptyToUnspecified(String s) {
        return (s == null || s.trim().isEmpty() || s.equalsIgnoreCase("null")) ? "BelirtilmemiÅŸ" : s.trim();
    }

    private List<String> getUserSkillsNormalized(User user) {
        if (user == null || user.getProfile() == null || user.getProfile().getSkills() == null) return new ArrayList<>();
        return user.getProfile().getSkills().stream().map(s -> s.getSkillName() == null ? "" : s.getSkillName().toLowerCase().trim()).filter(s -> !s.isBlank()).distinct().collect(Collectors.toList());
    }

    private boolean isUserHasSkill(List<String> userSkills, String reqSkill) {
        if (reqSkill == null || reqSkill.isBlank()) return false;
        String r = reqSkill.toLowerCase().trim();
        return userSkills.stream().anyMatch(u -> r.contains(u) || u.contains(r));
    }

    private JobPosting saveJobPosting(User user, String url, JobAiResult aiData, String rawText, String report) {
        JobPosting jp = JobPosting.builder().user(user).url(url).position(safeTruncate(aiData.position, 255)).cleanedText(safeTruncate(rawText, 4000)).requiredSkills(safeTruncate(String.join(", ", aiData.technicalSkills), 2000)).responsibilities(safeTruncate(String.join("; ", aiData.responsibilities), 2000)).analysisReport(safeTruncate(report, 4000)).createdAt(new Date()).build();
        return jobPostingRepository.save(jp);
    }

    private String generateUniversalReport(JobAiResult d, List<String> m) {
        StringBuilder sb = new StringBuilder("### DETAYLI Ä°Åž ANALÄ°ZÄ° RAPORU\n\n");
        sb.append("Pozisyon: ").append(emptyToUnspecified(d.position)).append("\n");
        sb.append("Firma: ").append(emptyToUnspecified(d.company)).append("\n\n");
        sb.append("Gereklilikler:\n");
        if (d.technicalSkills.isEmpty()) sb.append("BelirtilmemiÅŸ\n");
        else for (String s : d.technicalSkills) sb.append(m.contains(s) ? "âœ… " : "âŒ ").append(s).append("\n");
        return sb.toString();
    }

    private JobAiResult parseAiResult(String json) {
        JobAiResult r = new JobAiResult();
        try {
            JsonNode root = objectMapper.readTree(json == null ? "{}" : json);
            r.position = getText(root, "position");
            r.company = getText(root, "company");
            if (root.has("technicalSkills") && root.get("technicalSkills").isArray()) {
                r.technicalSkills = StreamSupport.stream(root.get("technicalSkills").spliterator(), false).map(JsonNode::asText).filter(s -> s != null && !s.isBlank()).distinct().collect(Collectors.toList());
            }
            if (root.has("responsibilities") && root.get("responsibilities").isArray()) {
                r.responsibilities = StreamSupport.stream(root.get("responsibilities").spliterator(), false).map(JsonNode::asText).filter(s -> s != null && !s.isBlank()).distinct().collect(Collectors.toList());
            }
        } catch (Exception e) { log.error("JSON Parse HatasÄ±: ", e); }
        return r;
    }

    private String getText(JsonNode n, String f) { return (n != null && n.has(f) && !n.get(f).isNull()) ? n.get(f).asText("") : ""; }

    @Override
    public List<JobPosting> getJobsByUserId(Long uId) { return jobPostingRepository.findByUserIdOrderByCreatedAtDesc(uId); }

    @Override
    public JobPosting getJobById(Long jId) { return jobPostingRepository.findById(jId).orElseThrow(() -> new RuntimeException("Ä°ÅŸ ilanÄ± bulunamadÄ±")); }

    private static class JobAiResult {
        String position = "", company = "", location = "", workType = "", experienceLevel = "", educationLevel = "", militaryStatus = "", salary = "", summary = "";
        List<String> technicalSkills = new ArrayList<>(), responsibilities = new ArrayList<>();
    }
}